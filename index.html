<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Hub</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    
    /* Override the active navbar item styles */
    .navbar-dark .navbar-nav .nav-link.active {
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      position: relative;
      font-weight: bold;
    }
    
    .navbar-dark .navbar-nav .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 10%;
      width: 80%;
      height: 3px;
      background-color: #fff;
      border-radius: 3px;
    }
    
    /* Responsive styles */
    @media (max-width: 767px) {
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls-group {
        width: 100%;
      }
      
      .search-container {
        width: 100%;
      }
      
      .sort-container, .filter-container {
        flex-wrap: wrap;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .button-container {
        flex-wrap: wrap;
      }
      
      /* Make buttons larger on mobile for easier tapping */
      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
      }
      
      /* Adjust box padding on mobile */
      .assignment-box, .resource-box, .announcement-box, 
      .quicklink-box, .recap-box, .schedule-box {
        padding: 15px 10px;
      }
    }
    
    /* Small phone screens */
    @media (max-width: 575px) {
      h1 {
        font-size: 1.5rem;
      }
      
      .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }
      
      .d-flex.justify-content-between.align-items-center.mb-4 button {
        width: 100%;
      }
    }
    
    a { margin-right: 10px; }
    a:visited { color: blue; }
    #assignment-list { list-style-type: none; padding-left: 0; }
    
    /* Assignment box styles */
    .assignment-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
      position: relative; /* For button positioning */
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    /* Subtle hover effect for better usability */
    .assignment-box:hover,
    .resource-box:hover,
    .announcement-box:hover,
    .quicklink-box:hover,
    .recap-box:hover,
    .schedule-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Archived assignment style */
    .assignment-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .assignment-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }
    
    /* Starred assignment style */
    .assignment-starred {
      border-color: #f1c40f;
      border-width: 2px;
      box-shadow: 0 0 5px rgba(241, 196, 15, 0.3);
    }
    
    .assignment-starred::before {
      content: "★";
      position: absolute;
      top: 5px;
      right: 5px;
      color: #f1c40f;
      font-size: 1.2em;
    }
    
    /* Empty state message */
    .empty-message {
      text-align: center;
      color: #777;
      margin: 20px 0;
      font-style: italic;
    }
    
    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      margin: 20px 0 10px 0;
    }
    
    .section-header h2 {
      margin: 0;
      margin-right: 10px;
    }
    
    .section-count {
      background-color: #eee;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.8em;
      color: #555;
    }
    
    .assignment-title {
      font-size: 1.2em;
      font-weight: bold;
      margin: 0 0 5px 0; 
    }
    
    .assignment-subject {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      margin: 0 0 10px 0;
      color: white;
      font-weight: bold;
    }
    
    .assignment-description {
      margin-top: 10px;
      font-size: 0.95em;
      color: #333;
      white-space: pre-line;
    }
    
    .assignment-deadline {
      margin-top: 10px;
      font-size: 0.9em;
      color: #e74c3c;
      font-weight: 500;
    }
    
    .deadline-passed {
      color: #e74c3c;
    }
    
    .deadline-approaching {
      color: #f39c12;
    }
    
    .deadline-future {
      color: #27ae60;
    }
    
    /* Search bar styles */
    .search-container {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 500px;
    }
    
    .search-container input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1em;
      width: 100%;
    }
    
    .search-container button {
      background: none;
      border: none;
      color: #777;
      cursor: pointer;
      font-size: 1.2em;
      padding: 0 10px;
      min-width: 40px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-container button:hover {
      color: #333;
    }
    
    .search-highlight {
      background-color: #ffeb3b;
      padding: 0 2px;
      border-radius: 2px;
    }
    
    /* Deadline container styles */
    .deadline-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .deadline-date {
      flex: 2;
    }
    
    .deadline-time {
      flex: 1;
    }
    
    .all-day-container {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    
    .all-day-container input {
      margin-right: 5px;
      width: auto;
    }
    
    .all-day-container label {
      display: inline;
      margin: 0;
    }
    
    /* Subject tag colors */
    .subject-Math { background-color: #4285F4; }
    .subject-Science { background-color: #0F9D58; }
    .subject-English { background-color: #DB4437; }
    .subject-Filipino { background-color: #F4B400; }
    .subject-MAPEH-Music { background-color: #AA47BC; }
    .subject-MAPEH-Arts { background-color: #26A69A; }
    .subject-MAPEH-PE { background-color: #5C6BC0; }
    .subject-MAPEH-Health { background-color: #EC407A; }
    .subject-Research { background-color: #7E57C2; }
    .subject-Geometry { background-color: #42A5F5; }
    .subject-Electronics { background-color: #66BB6A; }
    .subject-Values { background-color: #FFA726; }
    .subject-Araling { background-color: #8D6E63; }
    .subject-Homeroom { background-color: #009688; }
    .subject-All { background: linear-gradient(90deg, #4285F4, #0F9D58, #DB4437, #F4B400); color: white; }

    /* Modal styles */
    #assignment-modal, #resource-modal, #announcement-modal, #quicklink-modal, #recap-modal, #schedule-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
      box-sizing: border-box;
    }

    #assignment-modal .modal-content,
    #resource-modal .modal-content,
    #announcement-modal .modal-content,
    #quicklink-modal .modal-content,
    #recap-modal .modal-content,
    #schedule-modal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    @media (max-width: 767px) {
      #assignment-modal .modal-content,
      #resource-modal .modal-content,
      #announcement-modal .modal-content,
      #quicklink-modal .modal-content,
      #recap-modal .modal-content,
      #schedule-modal .modal-content {
        padding: 15px;
        max-height: 90vh;
      }
    }
    
    #modal-description {
      width: 100%;
      min-height: 80px;
      margin-top: 10px;
      resize: vertical;
    }
    
    .form-group {
      margin: 15px 0;
      text-align: left;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Improve form inputs on mobile */
    @media (max-width: 767px) {
      .form-group {
        margin: 12px 0;
      }
      
      .form-group input, .form-group select, .form-group textarea {
        padding: 12px;
      }
      
      /* Modal footer buttons */
      .modal-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }
      
      .modal-footer button {
        flex: 1;
        margin: 0 5px;
      }
    }
    
    /* Filter styles */
    .filter-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-container select {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      min-width: 150px;
    }
    
    .filter-label {
      font-size: 0.9em;
      color: #555;
      font-weight: 500;
    }
    
    .active-filter {
      display: inline-flex;
      align-items: center;
      background-color: #e1f5fe;
      color: #0288d1;
      padding: 6px 12px;
      border-radius: 16px;
      margin-right: 8px;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    
    .active-filter button {
      background: none;
      border: none;
      color: #0288d1;
      cursor: pointer;
      margin-left: 5px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .active-filter button:hover {
      background-color: rgba(2, 136, 209, 0.1);
    }
    
    /* Sort styles */
    .sort-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .sort-container select {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      min-width: 120px;
    }
    
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .controls-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .controls-label {
      font-size: 0.9em;
      color: #555;
      font-weight: 500;
      white-space: nowrap;
    }
    
    /* Resource styles */
    .resource-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      position: relative;
    }
    
    .resource-title {
      font-size: 1.2em;
      font-weight: bold;
      margin: 0 0 5px 0;
    }
    
    .resource-subject {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      margin: 0 0 10px 0;
      color: white;
      font-weight: bold;
    }
    
    .resource-description {
      margin-top: 10px;
      font-size: 0.95em;
      color: #333;
      white-space: pre-line;
    }
    
    .resource-link {
      margin-top: 10px;
      display: block;
    }
    
    .resource-link a {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: #2196F3;
      font-weight: 500;
    }
    
    .resource-link a:hover {
      text-decoration: underline;
    }
    
    .resource-link .icon {
      margin-right: 5px;
      font-size: 1.2em;
    }
    
    .resource-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .resource-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }
    
    .resource-starred {
      border-color: #f1c40f;
      border-width: 2px;
      box-shadow: 0 0 5px rgba(241, 196, 15, 0.3);
    }
    
    .resource-starred::before {
      content: "★";
      position: absolute;
      top: 5px;
      right: 5px;
      color: #f1c40f;
      font-size: 1.2em;
    }

    /* Announcement styles */
    .announcement-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
      position: relative;
    }
    
    .announcement-title {
      font-size: 1.3em;
      font-weight: bold;
      margin: 0 0 10px 0;
    }
    
    .announcement-text {
      white-space: pre-line;
      margin-bottom: 15px;
    }
    
    .announcement-attachments {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .attachment-item {
      max-width: 300px;
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    @media (max-width: 767px) {
      .announcement-attachments {
        gap: 10px;
      }
      
      .attachment-item {
        max-width: 100%;
      }
      
      .attachment-image {
        width: 100%;
        height: auto;
      }
    }
    
    .attachment-image {
      max-width: 100%;
      display: block;
    }
    
    .attachment-link {
      padding: 8px;
      display: flex;
      align-items: center;
      text-decoration: none;
      color: #2196F3;
    }
    
    .attachment-icon {
      margin-right: 8px;
      font-size: 1.2em;
    }
    
    .announcement-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .announcement-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }
    
    .announcement-pinned {
      border-color: #e74c3c;
      border-width: 2px;
      box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
    }
    
    .announcement-pinned::before {
      content: "📌";
      position: absolute;
      top: 5px;
      right: 5px;
      color: #e74c3c;
      font-size: 1.2em;
    }

    /* Schedule styles */
    .schedule-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f0f8ff;
      position: relative;
    }
    
    .schedule-title {
      font-size: 1.2em;
      font-weight: bold;
      margin: 0 0 5px 0;
    }
    
    .schedule-date {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 15px;
      display: block;
    }
    
    .schedule-subjects {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .schedule-subject {
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #4285F4;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
    }
    
    .schedule-subject-title {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .schedule-subject-title span {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      color: white;
      background-color: #4285F4;
    }
    
    .schedule-subject-content {
      white-space: pre-line;
      font-size: 0.95em;
      flex-grow: 1;
    }
    
    .empty-content {
      font-style: italic;
      color: #999;
    }
    
    .schedule-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .schedule-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }
    
    .schedule-form-subjects {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    #schedule-modal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 600px;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      text-align: left;
    }
    
    /* Recap styles */
    .recap-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
      position: relative;
    }
    
    .recap-title {
      font-size: 1.2em;
      font-weight: bold;
      margin: 0 0 5px 0;
    }
    
    .recap-date {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 15px;
      display: block;
    }
    
    .recap-subjects {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .recap-subject {
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #4285F4;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
    }
    
    .recap-subject-title {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .recap-subject-title span {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      color: white;
      background-color: #4285F4;
    }
    
    .recap-subject-content {
      white-space: pre-line;
      font-size: 0.95em;
      flex-grow: 1;
    }
    
    .recap-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .recap-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }

    #recap-modal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 600px;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      text-align: left;
    }
    
    .recap-form-subjects {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .action-items-container {
      background-color: #fff8dc;
      border-left: 4px solid #ffd700;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
    }
    
    .action-items-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .action-items-list {
      list-style-type: disc;
      padding-left: 20px;
      margin-top: 10px;
    }
    
    .action-items-list li {
      margin-bottom: 5px;
    }
    
    /* Announcement modal styles */
    .attachment-input-container {
      position: relative;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    
    .attachment-btn {
      margin-right: 10px;
      padding: 5px 10px;
      border: 1px solid #ddd;
      background-color: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .attachment-btn:hover {
      background-color: #e9e9e9;
    }
    
    .attachment-controls {
      margin-top: 10px;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .toggle-label {
      margin: 0 10px;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 24px;
      transition: .4s;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      border-radius: 50%;
      transition: .4s;
    }
    
    input:checked + .toggle-slider {
      background-color: #2196F3;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      color: #f44336;
      font-size: 1.2em;
      cursor: pointer;
    }
    
    /* Image preview overlay */
    #image-preview-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    
    #image-preview-container {
      position: relative;
      max-width: 90%;
      max-height: 90%;
      margin: auto;
    }
    
    #image-preview {
      max-width: 100%;
      max-height: 90vh;
      border: 3px solid white;
      border-radius: 3px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    
    #image-preview-close {
      position: absolute;
      top: -40px;
      right: -40px;
      color: white;
      background: none;
      border: none;
      font-size: 2em;
      cursor: pointer;
    }
    
    .recap-form-subject {
      margin-bottom: 15px;
      padding: 10px;
      background-color: white;
      border-radius: 5px;
      border-left: 4px solid #4285F4;
    }
    
    .recap-form-subject-header {
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    /* Quick Link styles */
    .quicklink-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      position: relative;
    }
    
    .quicklink-title {
      font-size: 1.2em;
      font-weight: bold;
      margin: 0 0 5px 0;
    }
    
    .quicklink-subject {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      margin: 0 0 10px 0;
      color: white;
      font-weight: bold;
    }
    
    .quicklink-link {
      margin-top: 10px;
      display: block;
    }
    
    .quicklink-link a {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: #2196F3;
      font-weight: 500;
    }
    
    .quicklink-link a:hover {
      text-decoration: underline;
    }
    
    .quicklink-link .icon {
      margin-right: 5px;
      font-size: 1.2em;
    }
    
    .quicklink-archived {
      opacity: 0.6;
      background-color: #eaeaea;
      border-color: #ccc;
    }
    
    .quicklink-archived::before {
      content: "ARCHIVED";
      position: absolute;
      top: 0;
      right: 0;
      background-color: #777;
      color: white;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 0 5px 0 5px;
    }
    
    .quicklink-pinned {
      border-color: #f1c40f;
      border-width: 2px;
      box-shadow: 0 0 5px rgba(241, 196, 15, 0.3);
    }
    
    .quicklink-pinned::before {
      content: "📌";
      position: absolute;
      top: 5px;
      right: 5px;
      color: #f1c40f;
      font-size: 1.2em;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBvMOJfOZfVST1Zyz46pPHJ1ubka2EFVyM",
        authDomain: "ultimate-app-5f1a6.firebaseapp.com",
        projectId: "ultimate-app-5f1a6",
        storageBucket: "ultimate-app-5f1a6.firebasestorage.app",
        messagingSenderId: "285199445174",
        appId: "1:285199445174:web:be5bf47db0b9ede7ecca17",
        measurementId: "G-TEGD5DGYPE"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // Track current assignment being edited
    let currentEditId = null;
    
    // Store all assignments for filtering
    let allAssignmentsData = [];
    let currentSubjectFilter = '';
    let currentSearchQuery = '';
    let currentSortField = 'created';
let currentSortDirection = 'asc'; // asc = oldest first

    // Resources functions
    let allResourcesData = [];
    let currentResourceId = null;
    let currentResourceSubjectFilter = '';
    let currentResourceSearchQuery = '';
    let currentResourceSortField = 'created';
    let currentResourceSortDirection = 'asc';

    function setActiveNavItem(element) {
      // Remove active class from all nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add active class to the clicked nav link
      element.classList.add('active');
    }
    
    function showSection(id) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => section.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      
      // Update the active nav item based on the section
      const navLink = document.querySelector(`.nav-link[onclick*="showSection('${id}')"]`);
      if (navLink) {
        setActiveNavItem(navLink);
      }

      if (id === 'assignments') {
        loadAssignments(); // Reload when viewing
      } else if (id === 'resources') {
        loadResources(); // Reload when viewing resources
      } else if (id === 'recaps') {
        loadRecaps(); // Reload when viewing recaps
      } else if (id === 'announcements') {
        loadAnnouncements(); // Reload when viewing announcements
      } else if (id === 'quick-links') {
        loadQuickLinks(); // Reload when viewing quick links
      } else if (id === 'schedule') {
        loadSchedules(); // Reload when viewing schedules
      }
    }

    async function loadAssignments() {
      // Get all assignments
      const snapshot = await db.collection('assignments').orderBy('created').get();
      allAssignmentsData = []; // Reset the array
      
      // Also collect all unique subjects for the filter dropdown
      const subjects = new Set();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        allAssignmentsData.push({
          id: doc.id,
          ...data
        });
        
        // Add subject to the set if it exists
        if (data.subject) {
          subjects.add(data.subject);
        }
      });
      
      // Update the subject filter dropdown
      updateSubjectFilter(Array.from(subjects).sort());
      
      // Apply any existing filters
      applyFilters();
    }
    
    function updateSubjectFilter(subjects) {
      const filterSelect = document.getElementById('subject-filter');
      
      // Keep the first option (All Subjects)
      filterSelect.innerHTML = '<option value="">All Subjects</option>';
      
      // Add each subject as an option
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        filterSelect.appendChild(option);
      });
      
      // Set the current filter if there is one
      if (currentSubjectFilter) {
        filterSelect.value = currentSubjectFilter;
      }
    }
    
    function filterBySubject(subject) {
      currentSubjectFilter = subject;
      applyFilters();
    }
    
    function filterAssignments(query) {
      currentSearchQuery = query || '';
      applyFilters();
    }
    
    function applyFilters() {
      let filtered = [...allAssignmentsData];
      
      // Apply subject filter if selected
      if (currentSubjectFilter) {
        filtered = filtered.filter(assignment => 
          assignment.subject === currentSubjectFilter
        );
      }
      
      // Apply search query if present
      if (currentSearchQuery.trim() !== '') {
        const query = currentSearchQuery.toLowerCase().trim();
        filtered = filtered.filter(assignment => {
          const nameMatch = assignment.name && assignment.name.toLowerCase().includes(query);
          const subjectMatch = assignment.subject && assignment.subject.toLowerCase().includes(query);
          const descriptionMatch = assignment.description && assignment.description.toLowerCase().includes(query);
          
          return nameMatch || subjectMatch || descriptionMatch;
        });
      }
      
      // Sort the filtered results
      filtered = sortAssignments(filtered);
      
      // Update the active filters display
      updateActiveFilters();
      
      // Render the filtered assignments
      renderAssignments(filtered, currentSearchQuery);
    }
    
    function sortAssignments(assignments) {
      return [...assignments].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentSortField) {
          case 'name':
            valueA = (a.name || '').toLowerCase();
            valueB = (b.name || '').toLowerCase();
            break;
          case 'subject':
            valueA = (a.subject || '').toLowerCase();
            valueB = (b.subject || '').toLowerCase();
            break;
          case 'deadline':
            // Handle null dates
            if (!a.deadline && !b.deadline) return 0;
            if (!a.deadline) return currentSortDirection === 'asc' ? 1 : -1;
            if (!b.deadline) return currentSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const dateA = a.deadline.toDate ? a.deadline.toDate() : new Date(a.deadline);
            const dateB = b.deadline.toDate ? b.deadline.toDate() : new Date(b.deadline);
            
            valueA = dateA.getTime();
            valueB = dateB.getTime();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }
    
    function setSortField(field) {
      currentSortField = field;
      applyFilters();
    }
    
    function setSortDirection(direction) {
      currentSortDirection = direction;
      applyFilters();
    }
    
    function updateActiveFilters() {
      const activeFiltersContainer = document.getElementById('active-filters');
      activeFiltersContainer.innerHTML = '';
      
      if (currentSubjectFilter) {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Subject: ${currentSubjectFilter} <button onclick="clearSubjectFilter()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }
    
    function clearSubjectFilter() {
      currentSubjectFilter = '';
      document.getElementById('subject-filter').value = '';
      applyFilters();
    }
    
    function clearSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.value = '';
      currentSearchQuery = '';
      applyFilters();
    }
    
    function clearAllFilters() {
      clearSubjectFilter();
      clearSearch();
    }
    
    function renderAssignments(assignments, highlightText = '') {
      // Count starred, active, and archived assignments
      const starredAssignments = assignments.filter(a => a.starred && !a.archived);
      const activeAssignments = assignments.filter(a => !a.archived); // Include all non-archived assignments
      const archivedAssignments = assignments.filter(a => a.archived);
      
      // Render starred assignments section
      const starredSection = document.getElementById('starred-assignments');
      starredSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const starredHeader = document.createElement('div');
      starredHeader.className = 'section-header';
      const starredTitle = document.createElement('h2');
      starredTitle.textContent = 'Starred';
      const starredCount = document.createElement('span');
      starredCount.className = 'section-count';
      starredCount.textContent = starredAssignments.length;
      starredHeader.appendChild(starredTitle);
      starredHeader.appendChild(starredCount);
      starredSection.appendChild(starredHeader);
      
      // Create list container
      const starredList = document.createElement('ul');
      starredList.className = 'assignment-list';
      starredList.style.listStyleType = 'none';
      starredList.style.paddingLeft = '0';
      
      // Display message if no starred assignments
      if (starredAssignments.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No starred assignments match your search' : 'No starred assignments';
        starredSection.appendChild(emptyMessage);
      } else {
        // Render starred assignments
        starredAssignments.forEach(data => {
          starredList.appendChild(createAssignmentElement(data, highlightText));
        });
      }
      
      starredSection.appendChild(starredList);
      
      // Render all active assignments section
      const allSection = document.getElementById('all-assignments');
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'All Assignments';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeAssignments.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'assignment-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active assignments
      if (activeAssignments.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No assignments match your search' : 'No assignments';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active assignments
        activeAssignments.forEach(data => {
          allList.appendChild(createAssignmentElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived assignments
      if (archivedAssignments.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-assignments');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-assignments';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedAssignments.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'assignment-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived assignments
        archivedAssignments.forEach(data => {
          archivedList.appendChild(createAssignmentElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived assignments
        const archivedSection = document.getElementById('archived-assignments');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }
    
    function highlightText(text, query) {
      if (!query || query.trim() === '' || !text) {
        return text;
      }
      
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // Helper function to create assignment elements
    function createAssignmentElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'assignment-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('assignment-archived');
      }
      
      // Apply starred styling if needed
      if (data.starred) {
        box.classList.add('assignment-starred');
      }
      
      // Title
      const title = document.createElement('h3');
      title.className = 'assignment-title';
      if (highlightQuery && data.name) {
        title.innerHTML = highlightText(data.name || 'Untitled', highlightQuery);
      } else {
        title.textContent = data.name || 'Untitled';
      }
      
      // Subject
      const subject = document.createElement('span');
      subject.className = 'assignment-subject';
      if (data.subject) {
        const subjectClass = 'subject-' + data.subject.split('/')[0].replace(/\s+/g, '');
        subject.classList.add(subjectClass);
        if (highlightQuery) {
          subject.innerHTML = highlightText(data.subject, highlightQuery);
        } else {
          subject.textContent = data.subject;
        }
      } else {
        subject.textContent = 'No subject';
        subject.style.backgroundColor = '#999';
      }
      
      // Description
      let description = null;
      if (data.description) {
        description = document.createElement('div');
        description.className = 'assignment-description';
        if (highlightQuery) {
          description.innerHTML = highlightText(data.description, highlightQuery);
        } else {
          description.textContent = data.description;
        }
      }
      
      // Deadline
      let deadlineElement = null;
      if (data.deadline) {
        const deadlineDate = data.deadline.toDate ? data.deadline.toDate() : new Date(data.deadline);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let formattedDate;
        
        if (data.isAllDay) {
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          formattedDate = deadlineDate.toLocaleDateString('en-US', options) + " (All day)";
        } else {
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
          formattedDate = deadlineDate.toLocaleString('en-US', options);
        }
        
        deadlineElement = document.createElement('div');
        deadlineElement.className = 'assignment-deadline';
        
        // Calculate days until deadline (using date only, not time)
        const deadlineDay = new Date(deadlineDate);
        deadlineDay.setHours(0, 0, 0, 0);
        const diffTime = deadlineDay.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        // Apply appropriate class based on deadline proximity
        if (diffDays < 0) {
          deadlineElement.classList.add('deadline-passed');
          deadlineElement.textContent = `Deadline: ${formattedDate} (Overdue)`;
        } else if (diffDays === 0) {
          deadlineElement.classList.add('deadline-approaching');
          deadlineElement.textContent = `Deadline: ${formattedDate} (Today)`;
        } else if (diffDays === 1) {
          deadlineElement.classList.add('deadline-approaching');
          deadlineElement.textContent = `Deadline: ${formattedDate} (Tomorrow)`;
        } else if (diffDays <= 3) {
          deadlineElement.classList.add('deadline-approaching');
          deadlineElement.textContent = `Deadline: ${formattedDate} (In ${diffDays} days)`;
        } else {
          deadlineElement.classList.add('deadline-future');
          deadlineElement.textContent = `Deadline: ${formattedDate}`;
        }
      }
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => {
        promptEditAssignment(data);
      };
      
      // Star/Unstar Button
      const starBtn = document.createElement('button');
      starBtn.className = data.starred ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-outline-warning';
      starBtn.innerHTML = data.starred ? '<i class="bi bi-star-fill"></i> Unstar' : '<i class="bi bi-star"></i> Star';
      starBtn.onclick = async () => {
        try {
          await db.collection('assignments').doc(data.id).update({
            starred: !data.starred
          });
          await loadAssignments(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating star status:', error);
        }
      };
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = async () => {
        try {
          await db.collection('assignments').doc(data.id).update({
            archived: !data.archived
          });
          await loadAssignments(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating archive status:', error);
        }
      };
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = async () => {
        if (confirm(`Delete assignment "${data.name}"?`)) {
          try {
            await db.collection('assignments').doc(data.id).delete();
            await loadAssignments(); // Refresh list after deletion
          } catch (error) {
            console.error('Error deleting assignment:', error);
          }
        }
      };
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(starBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Assemble the box
      box.appendChild(title);
      box.appendChild(subject);
      if (description) box.appendChild(description);
      if (deadlineElement) box.appendChild(deadlineElement);
      box.appendChild(buttonContainer);
      
      // Add box to list
      item.appendChild(box);
      return item;
    }

    function promptNewAssignment() {
      // Reset the form
      document.getElementById('modal-input').value = '';
      document.getElementById('subject-select').value = '';
      document.getElementById('modal-description').value = '';
      document.getElementById('modal-deadline-date').value = '';
      document.getElementById('modal-deadline-time').value = '';
      document.getElementById('modal-all-day').checked = true;
      toggleDeadlineTime();
      
      // Reset edit state
      currentEditId = null;
      
      // Update modal title and button
      document.getElementById('modal-title').textContent = 'New Assignment';
      document.getElementById('modal-submit').textContent = 'Add';
      
      // Show the modal
      showModal('assignment-modal');
      document.getElementById('modal-input').focus();
    }
    
    function promptEditAssignment(data) {
      // Fill the form with existing data
      document.getElementById('modal-input').value = data.name || '';
      document.getElementById('subject-select').value = data.subject || '';
      document.getElementById('modal-description').value = data.description || '';
      
      // Format the deadline for the date input (YYYY-MM-DD)
      if (data.deadline) {
        const deadline = data.deadline.toDate ? data.deadline.toDate() : new Date(data.deadline);
        const year = deadline.getFullYear();
        const month = String(deadline.getMonth() + 1).padStart(2, '0');
        const day = String(deadline.getDate()).padStart(2, '0');
        document.getElementById('modal-deadline-date').value = `${year}-${month}-${day}`;
        
        // Check if it has a specific time or is all day
        if (data.isAllDay) {
          document.getElementById('modal-all-day').checked = true;
          document.getElementById('modal-deadline-time').value = '';
        } else {
          document.getElementById('modal-all-day').checked = false;
          const hours = String(deadline.getHours()).padStart(2, '0');
          const minutes = String(deadline.getMinutes()).padStart(2, '0');
          document.getElementById('modal-deadline-time').value = `${hours}:${minutes}`;
        }
        toggleDeadlineTime();
      } else {
        document.getElementById('modal-deadline-date').value = '';
        document.getElementById('modal-deadline-time').value = '';
        document.getElementById('modal-all-day').checked = true;
        toggleDeadlineTime();
      }
      
      // Set edit state
      currentEditId = data.id;
      
      // Update modal title and button
      document.getElementById('modal-title').textContent = 'Edit Assignment';
      document.getElementById('modal-submit').textContent = 'Update';
      
      // Show the modal
      document.getElementById('assignment-modal').style.display = 'flex';
      document.getElementById('modal-input').focus();
    }

    function toggleDeadlineTime() {
      const allDayCheckbox = document.getElementById('modal-all-day');
      const timeInput = document.getElementById('modal-deadline-time');
      
      if (allDayCheckbox.checked) {
        timeInput.disabled = true;
        timeInput.style.opacity = '0.5';
      } else {
        timeInput.disabled = false;
        timeInput.style.opacity = '1';
      }
    }

    function closeModal() {
      hideModal('assignment-modal');
    }

    async function submitAssignment() {
      const input = document.getElementById('modal-input');
      const subjectSelect = document.getElementById('subject-select');
      const description = document.getElementById('modal-description');
      const deadlineDateInput = document.getElementById('modal-deadline-date');
      const deadlineTimeInput = document.getElementById('modal-deadline-time');
      const isAllDay = document.getElementById('modal-all-day').checked;
      
      const name = input.value.trim();
      const subject = subjectSelect.value;
      const notes = description.value.trim();
      const deadlineDateValue = deadlineDateInput.value;
      
      let deadline = null;
      
      // Create deadline if date is provided
      if (deadlineDateValue) {
        if (isAllDay) {
          // Set to noon to avoid timezone issues
          deadline = new Date(`${deadlineDateValue}T12:00:00`);
        } else {
          const timeValue = deadlineTimeInput.value || '23:59';
          deadline = new Date(`${deadlineDateValue}T${timeValue}:00`);
        }
      }
      
      if (name === "") {
        alert("Assignment name cannot be empty.");
        return;
      }

      try {
        if (currentEditId) {
          // Update existing assignment
          await db.collection('assignments').doc(currentEditId).update({ 
            name: name, 
            subject: subject,
            description: notes,
            deadline: deadline,
            isAllDay: isAllDay
          });
        } else {
          // Create new assignment
          await db.collection('assignments').add({ 
            name: name, 
            subject: subject,
            description: notes,
            deadline: deadline,
            isAllDay: isAllDay,
            created: new Date(),
            archived: false,
            starred: false
          });
        }
        await loadAssignments(); // Refresh from Firestore
      } catch (error) {
        console.error('Error saving assignment:', error);
      }

      closeModal();
    }

    // Resources functions
    function showResourceModal(isEdit = false) {
      // Reset the form
      if (!isEdit) {
        document.getElementById('resource-input').value = '';
        document.getElementById('resource-subject-select').value = '';
        document.getElementById('resource-description').value = '';
        document.getElementById('resource-link').value = '';
        document.getElementById('resource-file').value = '';
        
        // Reset edit state
        currentResourceId = null;
        
        // Set to link by default
        document.getElementById('resource-type-toggle').checked = false;
        toggleResourceType();
        
        // Update modal title and button
        document.getElementById('resource-modal-title').textContent = 'New Resource';
        document.getElementById('resource-modal-submit').textContent = 'Add';
      }
      
      // Show the modal
      showModal('resource-modal');
      document.getElementById('resource-input').focus();
    }
    
    function toggleResourceType() {
      const isFile = document.getElementById('resource-type-toggle').checked;
      document.getElementById('resource-link-container').style.display = isFile ? 'none' : 'block';
      document.getElementById('resource-file-container').style.display = isFile ? 'block' : 'none';
    }
    
    function promptEditResource(data) {
      // Fill the form with existing data
      document.getElementById('resource-input').value = data.name || '';
      document.getElementById('resource-subject-select').value = data.subject || '';
      document.getElementById('resource-description').value = data.description || '';
      
      // Set the resource type
      const isFile = data.type === 'file';
      document.getElementById('resource-type-toggle').checked = isFile;
      toggleResourceType();
      
      if (isFile) {
        // Can't edit the file itself, just show filename
        document.getElementById('resource-file-name').textContent = data.filename || 'No file selected';
      } else {
        document.getElementById('resource-link').value = data.link || '';
      }
      
      // Set edit state
      currentResourceId = data.id;
      
      // Update modal title and button
      document.getElementById('resource-modal-title').textContent = 'Edit Resource';
      document.getElementById('resource-modal-submit').textContent = 'Update';
      
      // Show the modal
      showModal('resource-modal');
      document.getElementById('resource-input').focus();
    }
    
    function closeResourceModal() {
      hideModal('resource-modal');
    }
    
    async function submitResource() {
      const input = document.getElementById('resource-input');
      const subjectSelect = document.getElementById('resource-subject-select');
      const description = document.getElementById('resource-description');
      const isFile = document.getElementById('resource-type-toggle').checked;
      
      const name = input.value.trim();
      const subject = subjectSelect.value;
      const notes = description.value.trim();
      
      if (name === "") {
        alert("Resource name cannot be empty.");
        return;
      }
      
      let resourceData = {
        name: name,
        subject: subject,
        description: notes,
        type: isFile ? 'file' : 'link'
      };
      
      if (isFile) {
        const fileInput = document.getElementById('resource-file');
        if (fileInput.files.length === 0 && !currentResourceId) {
          alert("Please select a file.");
          return;
        }
        
        if (fileInput.files.length > 0) {
          // If we have a new file, we would upload it here
          // For now, just store the filename
          resourceData.filename = fileInput.files[0].name;
          resourceData.fileUrl = '#'; // Placeholder URL
        }
      } else {
        const link = document.getElementById('resource-link').value.trim();
        if (link === "") {
          alert("Resource link cannot be empty.");
          return;
        }
        resourceData.link = link;
      }
      
      try {
        if (currentResourceId) {
          // Update existing resource
          await db.collection('resources').doc(currentResourceId).update(resourceData);
        } else {
          // Create new resource
          resourceData.created = new Date();
          resourceData.archived = false;
          resourceData.starred = false;
          
          await db.collection('resources').add(resourceData);
        }
        await loadResources(); // Refresh from Firestore
      } catch (error) {
        console.error('Error saving resource:', error);
      }
      
      closeResourceModal();
    }
    
    async function loadResources() {
      // Get all resources
      const snapshot = await db.collection('resources').orderBy('created').get();
      allResourcesData = []; // Reset the array
      
      // Also collect all unique subjects for the filter dropdown
      const subjects = new Set();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        allResourcesData.push({
          id: doc.id,
          ...data
        });
        
        // Add subject to the set if it exists
        if (data.subject) {
          subjects.add(data.subject);
        }
      });
      
      // Update the subject filter dropdown
      updateResourceSubjectFilter(Array.from(subjects).sort());
      
      // Apply any existing filters
      applyResourceFilters();
    }
    
    function updateResourceSubjectFilter(subjects) {
      const filterSelect = document.getElementById('resource-subject-filter');
      
      // Keep the first option (All Subjects)
      filterSelect.innerHTML = '<option value="">All Subjects</option>';
      
      // Add each subject as an option
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        filterSelect.appendChild(option);
      });
      
      // Set the current filter if there is one
      if (currentResourceSubjectFilter) {
        filterSelect.value = currentResourceSubjectFilter;
      }
    }
    
    function filterResourcesBySubject(subject) {
      currentResourceSubjectFilter = subject;
      applyResourceFilters();
    }
    
    function filterResources(query) {
      currentResourceSearchQuery = query || '';
      applyResourceFilters();
    }
    
    function applyResourceFilters() {
      let filtered = [...allResourcesData];
      
      // Apply subject filter if selected
      if (currentResourceSubjectFilter) {
        filtered = filtered.filter(resource => 
          resource.subject === currentResourceSubjectFilter
        );
      }
      
      // Apply search query if present
      if (currentResourceSearchQuery.trim() !== '') {
        const query = currentResourceSearchQuery.toLowerCase().trim();
        filtered = filtered.filter(resource => {
          const nameMatch = resource.name && resource.name.toLowerCase().includes(query);
          const subjectMatch = resource.subject && resource.subject.toLowerCase().includes(query);
          const descriptionMatch = resource.description && resource.description.toLowerCase().includes(query);
          
          return nameMatch || subjectMatch || descriptionMatch;
        });
      }
      
      // Sort the filtered results
      filtered = sortResources(filtered);
      
      // Update the active filters display
      updateResourceActiveFilters();
      
      // Render the filtered resources
      renderResources(filtered, currentResourceSearchQuery);
    }
    
    function sortResources(resources) {
      return [...resources].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentResourceSortField) {
          case 'name':
            valueA = (a.name || '').toLowerCase();
            valueB = (b.name || '').toLowerCase();
            break;
          case 'subject':
            valueA = (a.subject || '').toLowerCase();
            valueB = (b.subject || '').toLowerCase();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentResourceSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentResourceSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentResourceSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }
    
    function setResourceSortField(field) {
      currentResourceSortField = field;
      applyResourceFilters();
    }
    
    function setResourceSortDirection(direction) {
      currentResourceSortDirection = direction;
      applyResourceFilters();
    }
    
    function updateResourceActiveFilters() {
      const activeFiltersContainer = document.getElementById('resource-active-filters');
      activeFiltersContainer.innerHTML = '';
      
      if (currentResourceSubjectFilter) {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Subject: ${currentResourceSubjectFilter} <button onclick="clearResourceSubjectFilter()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }
    
    function clearResourceSubjectFilter() {
      currentResourceSubjectFilter = '';
      document.getElementById('resource-subject-filter').value = '';
      applyResourceFilters();
    }
    
    function clearResourceSearch() {
      const searchInput = document.getElementById('resource-search-input');
      searchInput.value = '';
      currentResourceSearchQuery = '';
      applyResourceFilters();
    }
    
    function renderResources(resources, highlightText = '') {
      // Count starred, active, and archived resources
      const starredResources = resources.filter(r => r.starred && !r.archived);
      const activeResources = resources.filter(r => !r.archived); // Include all non-archived resources
      const archivedResources = resources.filter(r => r.archived);
      
      // Render starred resources section
      const starredSection = document.getElementById('starred-resources');
      starredSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const starredHeader = document.createElement('div');
      starredHeader.className = 'section-header';
      const starredTitle = document.createElement('h2');
      starredTitle.textContent = 'Starred';
      const starredCount = document.createElement('span');
      starredCount.className = 'section-count';
      starredCount.textContent = starredResources.length;
      starredHeader.appendChild(starredTitle);
      starredHeader.appendChild(starredCount);
      starredSection.appendChild(starredHeader);
      
      // Create list container
      const starredList = document.createElement('ul');
      starredList.className = 'resource-list';
      starredList.style.listStyleType = 'none';
      starredList.style.paddingLeft = '0';
      
      // Display message if no starred resources
      if (starredResources.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No starred resources match your search' : 'No starred resources';
        starredSection.appendChild(emptyMessage);
      } else {
        // Render starred resources
        starredResources.forEach(data => {
          starredList.appendChild(createResourceElement(data, highlightText));
        });
      }
      
      starredSection.appendChild(starredList);
      
      // Render all active resources section
      const allSection = document.getElementById('all-resources');
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'All Resources';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeResources.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'resource-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active resources
      if (activeResources.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No resources match your search' : 'No resources';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active resources
        activeResources.forEach(data => {
          allList.appendChild(createResourceElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived resources
      if (archivedResources.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-resources');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-resources';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedResources.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'resource-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived resources
        archivedResources.forEach(data => {
          archivedList.appendChild(createResourceElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived resources
        const archivedSection = document.getElementById('archived-resources');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }
    
    function createResourceElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'resource-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('resource-archived');
      }
      
      // Apply starred styling if needed
      if (data.starred) {
        box.classList.add('resource-starred');
      }
      
      // Title
      const title = document.createElement('h3');
      title.className = 'resource-title';
      if (highlightQuery && data.name) {
        title.innerHTML = highlightText(data.name || 'Untitled', highlightQuery);
      } else {
        title.textContent = data.name || 'Untitled';
      }
      
      // Subject
      const subject = document.createElement('span');
      subject.className = 'resource-subject';
      if (data.subject) {
        if (data.subject === "All Subjects") {
          subject.classList.add('subject-All');
        } else {
          const subjectClass = 'subject-' + data.subject.split('/')[0].replace(/\s+/g, '');
          subject.classList.add(subjectClass);
        }
        if (highlightQuery) {
          subject.innerHTML = highlightText(data.subject, highlightQuery);
        } else {
          subject.textContent = data.subject;
        }
      } else {
        subject.textContent = 'No subject';
        subject.style.backgroundColor = '#999';
      }
      
      // Description
      let description = null;
      if (data.description) {
        description = document.createElement('div');
        description.className = 'resource-description';
        if (highlightQuery) {
          description.innerHTML = highlightText(data.description, highlightQuery);
        } else {
          description.textContent = data.description;
        }
      }
      
      // Link or File
      let resourceLink = document.createElement('div');
      resourceLink.className = 'resource-link';
      
      const link = document.createElement('a');
      link.target = '_blank';
      
      if (data.type === 'file') {
        // File resource
        link.href = data.fileUrl || '#';
        link.innerHTML = '<span class="icon">📄</span> ' + (data.filename || 'Download File');
      } else {
        // Link resource
        link.href = data.link || '#';
        link.innerHTML = '<span class="icon">🔗</span> ' + (data.link || 'Open Link');
      }
      
      resourceLink.appendChild(link);
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => {
        promptEditResource(data);
      };
      
      // Star/Unstar Button
      const starBtn = document.createElement('button');
      starBtn.className = data.starred ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-outline-warning';
      starBtn.innerHTML = data.starred ? '<i class="bi bi-star-fill"></i> Unstar' : '<i class="bi bi-star"></i> Star';
      starBtn.onclick = async () => {
        try {
          await db.collection('resources').doc(data.id).update({
            starred: !data.starred
          });
          await loadResources(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating star status:', error);
        }
      };
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = async () => {
        try {
          await db.collection('resources').doc(data.id).update({
            archived: !data.archived
          });
          await loadResources(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating archive status:', error);
        }
      };
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = async () => {
        if (confirm(`Delete resource "${data.name}"?`)) {
          try {
            await db.collection('resources').doc(data.id).delete();
            await loadResources(); // Refresh list after deletion
          } catch (error) {
            console.error('Error deleting resource:', error);
          }
        }
      };
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(starBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Assemble the box
      box.appendChild(title);
      box.appendChild(subject);
      if (description) box.appendChild(description);
      box.appendChild(resourceLink);
      box.appendChild(buttonContainer);
      
      // Add box to list
      item.appendChild(box);
      return item;
    }

    // Global variables for announcements
    let allAnnouncementsData = [];
    let currentAnnouncementId = null;
    let currentAnnouncementSearchQuery = '';
    let currentAnnouncementSortField = 'created';
    let currentAnnouncementSortDirection = 'asc';
    let tempAttachments = [];

    // Announcement functions
    function showAnnouncementModal() {
      // Reset form
      document.getElementById('announcement-input').value = '';
      document.getElementById('announcement-text').value = '';
      document.getElementById('attachment-container').innerHTML = '';
      document.getElementById('announcement-modal-title').textContent = 'New Announcement';
      document.getElementById('announcement-modal-submit').textContent = 'Add';
      
      // Reset current announcement ID
      currentAnnouncementId = null;
      
      // Reset temporary attachments
      tempAttachments = [];
      
      // Show the modal
      showModal('announcement-modal');
      document.getElementById('announcement-input').focus();
    }
    
    function closeAnnouncementModal() {
      hideModal('announcement-modal');
    }
    
    function addImageAttachment() {
      const container = document.getElementById('attachment-container');
      const attachmentId = Date.now(); // Unique ID for this attachment
      
      const inputContainer = document.createElement('div');
      inputContainer.className = 'attachment-input-container';
      inputContainer.dataset.id = attachmentId;
      inputContainer.dataset.type = 'image';
      
      inputContainer.innerHTML = `
        <label>Image</label>
        <div class="toggle-container" style="margin: 5px 0;">
          <span class="toggle-label">URL</span>
          <label class="toggle-switch">
            <input type="checkbox" class="image-source-toggle" onchange="toggleImageSource(${attachmentId})">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">Upload</span>
        </div>
        <div class="image-url-container">
          <input type="text" placeholder="Enter image URL" class="attachment-url" />
        </div>
        <div class="image-file-container" style="display: none;">
          <input type="file" accept="image/*" class="attachment-file" />
          <p class="file-name" style="font-size: 0.9em; color: #666; margin-top: 5px;"></p>
        </div>
        <button class="remove-btn" onclick="removeAttachment(${attachmentId})">✕</button>
      `;
      
      container.appendChild(inputContainer);
      
      // Add to temp attachments
      tempAttachments.push({
        id: attachmentId,
        type: 'image',
        url: '',
        isUpload: false,
        file: null
      });
    }
    
    function toggleImageSource(id) {
      const container = document.querySelector(`.attachment-input-container[data-id="${id}"]`);
      if (!container) return;
      
      const toggle = container.querySelector('.image-source-toggle');
      const urlContainer = container.querySelector('.image-url-container');
      const fileContainer = container.querySelector('.image-file-container');
      
      if (toggle.checked) {
        // Upload mode
        urlContainer.style.display = 'none';
        fileContainer.style.display = 'block';
        
        // Update attachment data
        const attachmentIndex = tempAttachments.findIndex(a => a.id === id);
        if (attachmentIndex !== -1) {
          tempAttachments[attachmentIndex].isUpload = true;
        }
        
        // Add file change listener
        const fileInput = container.querySelector('.attachment-file');
        const fileNameDisplay = container.querySelector('.file-name');
        fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            const file = this.files[0];
            fileNameDisplay.textContent = file.name;
            
            // Update attachment data with file
            const attachmentIndex = tempAttachments.findIndex(a => a.id === id);
            if (attachmentIndex !== -1) {
              tempAttachments[attachmentIndex].file = file;
            }
          }
        });
      } else {
        // URL mode
        urlContainer.style.display = 'block';
        fileContainer.style.display = 'none';
        
        // Update attachment data
        const attachmentIndex = tempAttachments.findIndex(a => a.id === id);
        if (attachmentIndex !== -1) {
          tempAttachments[attachmentIndex].isUpload = false;
        }
      }
    }
    
    function addLinkAttachment() {
      const container = document.getElementById('attachment-container');
      const attachmentId = Date.now(); // Unique ID for this attachment
      
      const inputContainer = document.createElement('div');
      inputContainer.className = 'attachment-input-container';
      inputContainer.dataset.id = attachmentId;
      inputContainer.dataset.type = 'link';
      
      inputContainer.innerHTML = `
        <label>Link URL</label>
        <input type="text" placeholder="Enter URL" class="attachment-url" />
        <input type="text" placeholder="Link text (optional)" class="attachment-text" style="margin-top: 5px;" />
        <button class="remove-btn" onclick="removeAttachment(${attachmentId})">✕</button>
      `;
      
      container.appendChild(inputContainer);
      
      // Add to temp attachments
      tempAttachments.push({
        id: attachmentId,
        type: 'link',
        url: '',
        text: ''
      });
    }
    
    function removeAttachment(id) {
      // Remove from DOM
      const element = document.querySelector(`.attachment-input-container[data-id="${id}"]`);
      if (element) element.remove();
      
      // Remove from temp attachments
      tempAttachments = tempAttachments.filter(a => a.id !== id);
    }
    
    function collectAttachments() {
      const attachments = [];
      const containers = document.querySelectorAll('.attachment-input-container');
      
      containers.forEach(container => {
        const type = container.dataset.type;
        const id = parseInt(container.dataset.id);
        
        if (type === 'image') {
          const isUpload = container.querySelector('.image-source-toggle')?.checked || false;
          
          if (isUpload) {
            // Handle file upload
            const fileInput = container.querySelector('.attachment-file');
            if (fileInput && fileInput.files.length > 0) {
              const file = fileInput.files[0];
              
              // In a real app with Firebase, you would upload this to Firebase Storage
              // and get a permanent URL. For now, we'll use a data URL which will persist
              // after refresh, unlike blob URLs.
              
              // Create a promise to handle the file reading
              const readFileAsDataURL = new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
              });
              
              // Store a placeholder for now
              const attachment = {
                type: 'image',
                url: '', // Will be updated with data URL
                fileName: file.name,
                isUpload: true
              };
              
              attachments.push(attachment);
              
              // Read the file as data URL (this happens asynchronously)
              readFileAsDataURL
                .then(dataUrl => {
                  // Update the attachment URL with the data URL
                  attachment.url = dataUrl;
                })
                .catch(error => {
                  console.error('Error reading file:', error);
                });
            }
          } else {
            // Handle URL
            const url = container.querySelector('.attachment-url').value.trim();
            if (url) {
              attachments.push({
                type: 'image',
                url: url,
                isUpload: false
              });
            }
          }
        } else if (type === 'link') {
          const url = container.querySelector('.attachment-url').value.trim();
          const text = container.querySelector('.attachment-text').value.trim();
          if (url) {
            attachments.push({
              type: 'link',
              url: url,
              text: text || url
            });
          }
        }
      });
      
      return attachments;
    }
    
    async function submitAnnouncement() {
      const input = document.getElementById('announcement-input');
      const text = document.getElementById('announcement-text');
      
      const title = input.value.trim();
      const content = text.value.trim();
      
      if (title === "") {
        alert("Announcement title cannot be empty.");
        return;
      }
      
      // Show loading state
      const submitBtn = document.getElementById('announcement-modal-submit');
      const originalBtnText = submitBtn.textContent;
      submitBtn.textContent = "Processing...";
      submitBtn.disabled = true;
      
      try {
        // Collect attachments
        const attachments = collectAttachments();
        
        // Process any file uploads (convert to data URLs)
        // Wait for all file reads to complete
        const fileReads = [];
        const fileInputs = document.querySelectorAll('.attachment-file');
        
        fileInputs.forEach(fileInput => {
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const attachmentId = parseInt(fileInput.closest('.attachment-input-container').dataset.id);
            
            const fileReadPromise = new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                // Find the matching attachment and update its URL
                const attachment = attachments.find(a => 
                  a.type === 'image' && 
                  a.isUpload && 
                  a.fileName === file.name
                );
                
                if (attachment) {
                  attachment.url = reader.result;
                }
                resolve();
              };
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            fileReads.push(fileReadPromise);
          }
        });
        
        // Wait for all file reads to complete
        await Promise.all(fileReads);
        
        let announcementData = {
          name: title,
          text: content,
          attachments: attachments
        };
        
        if (currentAnnouncementId) {
          // Update existing announcement
          await db.collection('announcements').doc(currentAnnouncementId).update(announcementData);
        } else {
          // Create new announcement
          announcementData.created = new Date();
          announcementData.archived = false;
          announcementData.pinned = false;
          
          await db.collection('announcements').add(announcementData);
        }
        
        await loadAnnouncements(); // Refresh from Firestore
        closeAnnouncementModal();
      } catch (error) {
        console.error('Error saving announcement:', error);
        alert("There was an error saving the announcement. Please try again.");
        
        // Reset button state
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
      }
    }
    
    async function loadAnnouncements() {
      // Get all announcements
      const snapshot = await db.collection('announcements').orderBy('created').get();
      allAnnouncementsData = []; // Reset the array
      
      snapshot.forEach(doc => {
        const data = doc.data();
        allAnnouncementsData.push({
          id: doc.id,
          ...data
        });
      });
      
      // Apply any existing filters
      applyAnnouncementFilters();
    }
    
    function filterAnnouncements(query) {
      currentAnnouncementSearchQuery = query || '';
      applyAnnouncementFilters();
    }
    
    function applyAnnouncementFilters() {
      let filtered = [...allAnnouncementsData];
      
      // Apply search query if present
      if (currentAnnouncementSearchQuery.trim() !== '') {
        const query = currentAnnouncementSearchQuery.toLowerCase().trim();
        filtered = filtered.filter(announcement => {
          const nameMatch = announcement.name && announcement.name.toLowerCase().includes(query);
          const textMatch = announcement.text && announcement.text.toLowerCase().includes(query);
          
          return nameMatch || textMatch;
        });
      }
      
      // Sort the filtered results
      filtered = sortAnnouncements(filtered);
      
      // Update the active filters display
      updateAnnouncementActiveFilters();
      
      // Render the filtered announcements
      renderAnnouncements(filtered, currentAnnouncementSearchQuery);
    }
    
    function sortAnnouncements(announcements) {
      return [...announcements].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentAnnouncementSortField) {
          case 'name':
            valueA = (a.name || '').toLowerCase();
            valueB = (b.name || '').toLowerCase();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentAnnouncementSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentAnnouncementSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentAnnouncementSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }
    
    function setAnnouncementSortField(field) {
      currentAnnouncementSortField = field;
      applyAnnouncementFilters();
    }
    
    function setAnnouncementSortDirection(direction) {
      currentAnnouncementSortDirection = direction;
      applyAnnouncementFilters();
    }
    
    function updateAnnouncementActiveFilters() {
      const activeFiltersContainer = document.getElementById('announcement-active-filters');
      activeFiltersContainer.innerHTML = '';
      
      // Add search filter if present
      if (currentAnnouncementSearchQuery.trim() !== '') {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Search: ${currentAnnouncementSearchQuery} <button onclick="clearAnnouncementSearch()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }
    
    function clearAnnouncementSearch() {
      const searchInput = document.getElementById('announcement-search-input');
      searchInput.value = '';
      currentAnnouncementSearchQuery = '';
      applyAnnouncementFilters();
    }
    
    function renderAnnouncements(announcements, highlightText = '') {
      // Count pinned, active, and archived announcements
      const pinnedAnnouncements = announcements.filter(a => a.pinned && !a.archived);
      const activeAnnouncements = announcements.filter(a => !a.archived); // Include all non-archived announcements
      const archivedAnnouncements = announcements.filter(a => a.archived);
      
      // Render pinned announcements section
      const pinnedSection = document.getElementById('pinned-announcements');
      pinnedSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const pinnedHeader = document.createElement('div');
      pinnedHeader.className = 'section-header';
      const pinnedTitle = document.createElement('h2');
      pinnedTitle.textContent = 'Pinned';
      const pinnedCount = document.createElement('span');
      pinnedCount.className = 'section-count';
      pinnedCount.textContent = pinnedAnnouncements.length;
      pinnedHeader.appendChild(pinnedTitle);
      pinnedHeader.appendChild(pinnedCount);
      pinnedSection.appendChild(pinnedHeader);
      
      // Create list container
      const pinnedList = document.createElement('ul');
      pinnedList.className = 'announcement-list';
      pinnedList.style.listStyleType = 'none';
      pinnedList.style.paddingLeft = '0';
      
      // Display message if no pinned announcements
      if (pinnedAnnouncements.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No pinned announcements match your search' : 'No pinned announcements';
        pinnedSection.appendChild(emptyMessage);
      } else {
        // Render pinned announcements
        pinnedAnnouncements.forEach(data => {
          pinnedList.appendChild(createAnnouncementElement(data, highlightText));
        });
      }
      
      pinnedSection.appendChild(pinnedList);
      
      // Render all active announcements section
      const allSection = document.getElementById('all-announcements');
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'All Announcements';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeAnnouncements.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'announcement-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active announcements
      if (activeAnnouncements.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No announcements match your search' : 'No announcements';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active announcements
        activeAnnouncements.forEach(data => {
          allList.appendChild(createAnnouncementElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived announcements
      if (archivedAnnouncements.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-announcements');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-announcements';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedAnnouncements.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'announcement-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived announcements
        archivedAnnouncements.forEach(data => {
          archivedList.appendChild(createAnnouncementElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived announcements
        const archivedSection = document.getElementById('archived-announcements');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }
    
    function createAnnouncementElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'announcement-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('announcement-archived');
      }
      
      // Apply pinned styling if needed
      if (data.pinned) {
        box.classList.add('announcement-pinned');
      }
      
      // Title
      const title = document.createElement('h3');
      title.className = 'announcement-title';
      if (highlightQuery && data.name) {
        title.innerHTML = highlightText(data.name || 'Untitled', highlightQuery);
      } else {
        title.textContent = data.name || 'Untitled';
      }
      
      // Text
      let textElement = null;
      if (data.text) {
        textElement = document.createElement('div');
        textElement.className = 'announcement-text';
        if (highlightQuery) {
          textElement.innerHTML = highlightText(data.text, highlightQuery);
        } else {
          textElement.textContent = data.text;
        }
      }
      
      // Attachments
      let attachmentsContainer = null;
      if (data.attachments && data.attachments.length > 0) {
        attachmentsContainer = document.createElement('div');
        attachmentsContainer.className = 'announcement-attachments';
        
        data.attachments.forEach(attachment => {
          if (attachment.type === 'image') {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'attachment-item';
            
            // Check if we have a valid URL that's not a blob URL (which won't persist after refresh)
            const isValidUrl = attachment.url && 
                              !attachment.url.startsWith('blob:') && 
                              (attachment.url.startsWith('http://') || 
                               attachment.url.startsWith('https://') || 
                               attachment.url.startsWith('data:'));
            
            if (isValidUrl) {
              // Create image element
              const img = document.createElement('img');
              img.className = 'attachment-image';
              img.src = attachment.url;
              img.alt = attachment.fileName || 'Image attachment';
              img.loading = 'lazy';
              img.style.cursor = 'pointer'; // Add pointer cursor to indicate clickability
              
              // Add click handler to show enlarged preview
              img.onclick = function() {
                showImagePreview(attachment.url);
              };
              
              // Add error handler to show fallback if image fails to load
              img.onerror = function() {
                this.style.display = 'none';
                const fallback = document.createElement('div');
                fallback.className = 'image-fallback';
                fallback.innerHTML = '<span style="font-size: 2em;">🖼️</span><br>Image unavailable';
                fallback.style.padding = '20px';
                fallback.style.textAlign = 'center';
                fallback.style.backgroundColor = '#f5f5f5';
                fallback.style.borderRadius = '4px';
                imgContainer.appendChild(fallback);
              };
              
              imgContainer.appendChild(img);
            } else {
              // Show fallback for invalid or missing URL
              const fallback = document.createElement('div');
              fallback.className = 'image-fallback';
              fallback.innerHTML = '<span style="font-size: 2em;">🖼️</span><br>Image attachment';
              fallback.style.padding = '20px';
              fallback.style.textAlign = 'center';
              fallback.style.backgroundColor = '#f5f5f5';
              fallback.style.borderRadius = '4px';
              
              imgContainer.appendChild(fallback);
            }
            
            attachmentsContainer.appendChild(imgContainer);
          } else if (attachment.type === 'link') {
            const linkContainer = document.createElement('div');
            linkContainer.className = 'attachment-item';
            
            const icon = document.createElement('span');
            icon.className = 'attachment-icon';
            icon.textContent = '🔗';
            
            const link = document.createElement('a');
            link.className = 'attachment-link';
            link.href = attachment.url;
            link.target = '_blank';
            link.textContent = attachment.text || attachment.url;
            
            linkContainer.appendChild(icon);
            linkContainer.appendChild(link);
            attachmentsContainer.appendChild(linkContainer);
          }
        });
      }
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => {
        promptEditAnnouncement(data);
      };
      
      // Pin/Unpin Button
      const pinBtn = document.createElement('button');
      pinBtn.className = data.pinned ? 'btn btn-sm btn-danger' : 'btn btn-sm btn-outline-danger';
      pinBtn.innerHTML = data.pinned ? '<i class="bi bi-pin-fill"></i> Unpin' : '<i class="bi bi-pin"></i> Pin';
      pinBtn.onclick = async () => {
        try {
          await db.collection('announcements').doc(data.id).update({
            pinned: !data.pinned
          });
          await loadAnnouncements(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating pin status:', error);
        }
      };
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = async () => {
        try {
          await db.collection('announcements').doc(data.id).update({
            archived: !data.archived
          });
          await loadAnnouncements(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating archive status:', error);
        }
      };
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = async () => {
        if (confirm(`Delete announcement "${data.name}"?`)) {
          try {
            await db.collection('announcements').doc(data.id).delete();
            await loadAnnouncements(); // Refresh list after deletion
          } catch (error) {
            console.error('Error deleting announcement:', error);
          }
        }
      };
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(pinBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Assemble the box
      box.appendChild(title);
      if (textElement) box.appendChild(textElement);
      if (attachmentsContainer) box.appendChild(attachmentsContainer);
      box.appendChild(buttonContainer);
      
      // Add box to list
      item.appendChild(box);
      return item;
    }
    
    function promptEditAnnouncement(data) {
      // Set current announcement ID
      currentAnnouncementId = data.id;
      
      // Set form values
      document.getElementById('announcement-input').value = data.name || '';
      document.getElementById('announcement-text').value = data.text || '';
      
      // Clear attachment container
      const attachmentContainer = document.getElementById('attachment-container');
      attachmentContainer.innerHTML = '';
      
      // Reset temp attachments
      tempAttachments = [];
      
      // Add existing attachments
      if (data.attachments && data.attachments.length > 0) {
        data.attachments.forEach(attachment => {
          const attachmentId = Date.now() + Math.random();
          
          if (attachment.type === 'image') {
            const inputContainer = document.createElement('div');
            inputContainer.className = 'attachment-input-container';
            inputContainer.dataset.id = attachmentId;
            inputContainer.dataset.type = 'image';
            
            // Check if it was an uploaded image or URL
            const isUpload = attachment.isUpload || false;
            
            inputContainer.innerHTML = `
              <label>Image</label>
              <div class="toggle-container" style="margin: 5px 0;">
                <span class="toggle-label">URL</span>
                <label class="toggle-switch">
                  <input type="checkbox" class="image-source-toggle" onchange="toggleImageSource(${attachmentId})" ${isUpload ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">Upload</span>
              </div>
              <div class="image-url-container" ${isUpload ? 'style="display: none;"' : ''}>
                <input type="text" value="${attachment.url}" placeholder="Enter image URL" class="attachment-url" />
              </div>
              <div class="image-file-container" ${!isUpload ? 'style="display: none;"' : ''}>
                <input type="file" accept="image/*" class="attachment-file" />
                <p class="file-name" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                  ${attachment.fileName || 'Previously uploaded image'}
                </p>
                <img src="${attachment.url}" alt="Preview" style="max-width: 100%; max-height: 150px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="showImagePreview('${attachment.url}')" />
              </div>
              <button class="remove-btn" onclick="removeAttachment(${attachmentId})">✕</button>
            `;
            
            attachmentContainer.appendChild(inputContainer);
            
            // Add to temp attachments
            tempAttachments.push({
              id: attachmentId,
              type: 'image',
              url: attachment.url,
              isUpload: isUpload,
              fileName: attachment.fileName || ''
            });
          } else if (attachment.type === 'link') {
            const inputContainer = document.createElement('div');
            inputContainer.className = 'attachment-input-container';
            inputContainer.dataset.id = attachmentId;
            inputContainer.dataset.type = 'link';
            
            inputContainer.innerHTML = `
              <label>Link URL</label>
              <input type="text" value="${attachment.url}" placeholder="Enter URL" class="attachment-url" />
              <input type="text" value="${attachment.text || ''}" placeholder="Link text (optional)" class="attachment-text" style="margin-top: 5px;" />
              <button class="remove-btn" onclick="removeAttachment(${attachmentId})">✕</button>
            `;
            
            attachmentContainer.appendChild(inputContainer);
            
            // Add to temp attachments
            tempAttachments.push({
              id: attachmentId,
              type: 'link',
              url: attachment.url,
              text: attachment.text || ''
            });
          }
        });
      }
      
      // Update modal title and button
      document.getElementById('announcement-modal-title').textContent = 'Edit Announcement';
      document.getElementById('announcement-modal-submit').textContent = 'Update';
      
      // Show the modal
      showModal('announcement-modal');
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
      } else {
        console.error(`Modal with id ${modalId} not found`);
      }
    }
    
    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      } else {
        console.error(`Modal with id ${modalId} not found`);
      }
    }

    // Global variables for recaps
    let allRecapsData = [];
    let currentRecapId = null;
    let currentRecapSearchQuery = '';
    let currentRecapDateFilter = '';
    let currentRecapSortField = 'date';
    let currentRecapSortDirection = 'desc';

    // Recap functions
    function showRecapModal(isEdit = false) {
      // Reset the form if not editing
      if (!isEdit) {
        document.getElementById('recap-date').value = formatDateForInput(new Date());
        
        // Clear all subject textareas
        const subjectTextareas = document.querySelectorAll('[id^="recap-subject-"]');
        subjectTextareas.forEach(textarea => {
          textarea.value = '';
        });
        
        // Reset edit state
        currentRecapId = null;
        
        // Update modal title and button
        document.getElementById('recap-modal-title').textContent = 'New Recap';
        document.getElementById('recap-modal-submit').textContent = 'Add';
      }
      
      // Show the modal
      showModal('recap-modal');
      document.getElementById('recap-date').focus();
    }
    
    function closeRecapModal() {
      hideModal('recap-modal');
    }
    
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function formatDateForDisplay(dateString) {
      const date = new Date(dateString);
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }
    
    async function submitRecap() {
      const dateInput = document.getElementById('recap-date');
      const date = dateInput.value;
      
      if (!date) {
        alert("Please select a date for the recap.");
        return;
      }
      
      // Collect all subject data
      const subjects = {};
      const subjectIDs = [
        { key: 'math', name: 'Math' },
        { key: 'science', name: 'Science' },
        { key: 'english', name: 'English' },
        { key: 'filipino', name: 'Filipino' },
        { key: 'mapeh-music', name: 'MAPEH/Music' },
        { key: 'mapeh-arts', name: 'MAPEH/Arts' },
        { key: 'mapeh-pe', name: 'MAPEH/PE' },
        { key: 'mapeh-health', name: 'MAPEH/Health' },
        { key: 'research', name: 'Research 2' },
        { key: 'geometry', name: 'Analytic Geometry' },
        { key: 'electronics', name: 'Electronics and Robotics' },
        { key: 'values', name: 'Values' },
        { key: 'araling', name: 'Araling Panlipunan' },
        { key: 'homeroom', name: 'Homeroom' }
      ];
      
      // Check if at least one subject has content
      let hasContent = false;
      
      subjectIDs.forEach(subject => {
        const content = document.getElementById(`recap-subject-${subject.key}`).value.trim();
        if (content) {
          hasContent = true;
          subjects[subject.name] = content;
        }
      });
      
      if (!hasContent) {
        alert("Please add content for at least one subject.");
        return;
      }
      
      // Process action items
      const actionItemsText = document.getElementById('recap-action-items').value;
      let actionItems = [];
      
      if (actionItemsText.trim()) {
        // Split by new lines and filter out empty lines
        actionItems = actionItemsText.split('\n')
          .map(item => item.trim())
          .filter(item => item.length > 0);
      }
      
      try {
        if (currentRecapId) {
          // Update existing recap
          await db.collection('recaps').doc(currentRecapId).update({
            date: new Date(date),
            subjects: subjects,
            actionItems: actionItems,
            lastUpdated: new Date()
          });
        } else {
          // Create new recap
          await db.collection('recaps').add({
            date: new Date(date),
            subjects: subjects,
            actionItems: actionItems,
            created: new Date(),
            archived: false
          });
        }
        
        closeRecapModal();
        await loadRecaps(); // Refresh list after adding/updating
      } catch (error) {
        console.error('Error saving recap:', error);
        alert("Error saving recap: " + error.message);
      }
    }
    
    async function loadRecaps() {
      try {
        console.log("Loading recaps...");
        // Get all recaps
        const snapshot = await db.collection('recaps').orderBy('date', 'desc').get();
        allRecapsData = []; // Reset the array
        
        snapshot.forEach(doc => {
          const data = doc.data();
          allRecapsData.push({
            id: doc.id,
            ...data
          });
        });
        
        console.log("Recaps loaded:", allRecapsData.length);
        
        // Apply any existing filters
        applyRecapFilters();
      } catch (error) {
        console.error('Error loading recaps:', error);
      }
    }
    
    function filterRecaps(query) {
      currentRecapSearchQuery = query || '';
      applyRecapFilters();
    }
    
    function filterRecapsByDate(date) {
      currentRecapDateFilter = date || '';
      updateRecapActiveFilters();
      applyRecapFilters();
    }
    
    function applyRecapFilters() {
      let filtered = [...allRecapsData];
      
      // Apply date filter if selected
      if (currentRecapDateFilter) {
        const filterDate = new Date(currentRecapDateFilter);
        filterDate.setHours(0, 0, 0, 0); // Reset time to start of day
        
        filtered = filtered.filter(recap => {
          const recapDate = recap.date.toDate ? recap.date.toDate() : new Date(recap.date);
          recapDate.setHours(0, 0, 0, 0); // Reset time to start of day
          return recapDate.getTime() === filterDate.getTime();
        });
      }
      
      // Apply search query if present
      if (currentRecapSearchQuery.trim() !== '') {
        const query = currentRecapSearchQuery.toLowerCase().trim();
        filtered = filtered.filter(recap => {
          // Check if any subject content matches the query
          if (recap.subjects) {
            for (const subject in recap.subjects) {
              if (recap.subjects[subject].toLowerCase().includes(query) || 
                  subject.toLowerCase().includes(query)) {
                return true;
              }
            }
          }
          
          // No matches found
          return false;
        });
      }
      
      // Sort the filtered results
      filtered = sortRecaps(filtered);
      
      // Update the active filters display
      updateRecapActiveFilters();
      
      // Render the filtered recaps
      renderRecaps(filtered, currentRecapSearchQuery);
    }
    
    function sortRecaps(recaps) {
      return [...recaps].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentRecapSortField) {
          case 'date':
            // Handle null dates
            if (!a.date && !b.date) return 0;
            if (!a.date) return currentRecapSortDirection === 'asc' ? 1 : -1;
            if (!b.date) return currentRecapSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date);
            const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date);
            
            valueA = dateA.getTime();
            valueB = dateB.getTime();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentRecapSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentRecapSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentRecapSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }
    
    function setRecapSortField(field) {
      currentRecapSortField = field;
      applyRecapFilters();
    }
    
    function setRecapSortDirection(direction) {
      currentRecapSortDirection = direction;
      applyRecapFilters();
    }
    
    function updateRecapActiveFilters() {
      const activeFiltersContainer = document.getElementById('recap-active-filters');
      // Check if the element exists before trying to update it
      if (!activeFiltersContainer) return;
      
      activeFiltersContainer.innerHTML = '';
      
      if (currentRecapDateFilter) {
        const filterDate = new Date(currentRecapDateFilter);
        const formattedDate = filterDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Date: ${formattedDate} <button onclick="clearRecapDateFilter()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
      
      // Add search filter if present
      if (currentRecapSearchQuery.trim() !== '') {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Search: ${currentRecapSearchQuery} <button onclick="clearRecapSearch()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }
    
    function clearRecapDateFilter() {
      currentRecapDateFilter = '';
      const dateFilter = document.getElementById('recap-date-filter');
      if (dateFilter) dateFilter.value = '';
      applyRecapFilters();
    }
    
    function clearRecapSearch() {
      const searchInput = document.getElementById('recap-search-input');
      if (searchInput) searchInput.value = '';
      currentRecapSearchQuery = '';
      applyRecapFilters();
    }
    
    function renderRecaps(recaps, highlightText = '') {
      console.log("Rendering recaps:", recaps.length);
      
      // Count active and archived recaps
      const activeRecaps = recaps.filter(r => !r.archived);
      const archivedRecaps = recaps.filter(r => r.archived);
      
      console.log("Active recaps:", activeRecaps.length, "Archived recaps:", archivedRecaps.length);
      
      // Render all active recaps section
      const allSection = document.getElementById('all-recaps');
      // Check if the element exists before trying to update it
      if (!allSection) {
        console.error("all-recaps element not found!");
        return;
      }
      
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'All Recaps';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeRecaps.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'recap-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active recaps
      if (activeRecaps.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No recaps match your search' : 'No recaps';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active recaps
        activeRecaps.forEach(data => {
          allList.appendChild(createRecapElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived recaps
      if (archivedRecaps.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-recaps');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-recaps';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedRecaps.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'recap-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived recaps
        archivedRecaps.forEach(data => {
          archivedList.appendChild(createRecapElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived recaps
        const archivedSection = document.getElementById('archived-recaps');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }
    
    function createRecapElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'recap-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('recap-archived');
      }
      
      // Title (Date)
      const title = document.createElement('h3');
      title.className = 'recap-title';
      
      // Format the date
      const recapDate = data.date.toDate ? data.date.toDate() : new Date(data.date);
      title.textContent = formatDateForDisplay(recapDate);
      
      // Date display
      const dateDisplay = document.createElement('span');
      dateDisplay.className = 'recap-date';
      
      // Show when it was created or last updated
      if (data.lastUpdated) {
        const updatedDate = data.lastUpdated.toDate ? data.lastUpdated.toDate() : new Date(data.lastUpdated);
        dateDisplay.textContent = `Last updated: ${updatedDate.toLocaleDateString('en-US')} ${updatedDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}`;
      } else if (data.created) {
        const createdDate = data.created.toDate ? data.created.toDate() : new Date(data.created);
        dateDisplay.textContent = `Created: ${createdDate.toLocaleDateString('en-US')} ${createdDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}`;
      }
      
      // Subjects container
      const subjectsContainer = document.createElement('div');
      subjectsContainer.className = 'recap-subjects';
      
      // Define all possible subjects to ensure they all appear
      const allSubjects = [
        'Math', 'Science', 'English', 'Filipino', 
        'MAPEH/Music', 'MAPEH/Arts', 'MAPEH/PE', 'MAPEH/Health',
        'Research 2', 'Analytic Geometry', 'Electronics and Robotics',
        'Values', 'Araling Panlipunan', 'Homeroom'
      ];
      
      // Process all subjects
      allSubjects.forEach(subject => {
        const subjectElement = document.createElement('div');
        subjectElement.className = 'recap-subject';
        
        // Get the subject category for styling
        const subjectCategory = subject.split('/')[0];
        subjectElement.style.borderLeftColor = getSubjectColor(subjectCategory);
        
        // Subject title
        const subjectTitle = document.createElement('div');
        subjectTitle.className = 'recap-subject-title';
        
        // Subject name
        const subjectName = document.createElement('div');
        subjectName.textContent = subject;
        
        // Subject badge (optional)
        const subjectBadge = document.createElement('span');
        subjectBadge.style.backgroundColor = getSubjectColor(subjectCategory);
        subjectBadge.textContent = subjectCategory;
        
        subjectTitle.appendChild(subjectName);
        subjectTitle.appendChild(subjectBadge);
        
        // Subject content
        const subjectContent = document.createElement('div');
        subjectContent.className = 'recap-subject-content';
        
        // Check if there's content for this subject
        if (data.subjects && data.subjects[subject] && data.subjects[subject].trim()) {
          // Highlight matching text if query provided
          if (highlightQuery && highlightQuery.trim() !== '') {
            subjectContent.innerHTML = highlightText(data.subjects[subject], highlightQuery);
          } else {
            subjectContent.textContent = data.subjects[subject];
          }
        } else {
          subjectContent.innerHTML = '<span class="empty-content">No data</span>';
        }
        
        subjectElement.appendChild(subjectTitle);
        subjectElement.appendChild(subjectContent);
        subjectsContainer.appendChild(subjectElement);
      });
      
      // We'll add Action Items after the subjects container
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => {
        promptEditRecap(data);
      };
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = async () => {
        try {
          await db.collection('recaps').doc(data.id).update({
            archived: !data.archived
          });
          await loadRecaps(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating archive status:', error);
        }
      };
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = async () => {
        if (confirm(`Delete this recap from ${title.textContent}?`)) {
          try {
            await db.collection('recaps').doc(data.id).delete();
            await loadRecaps(); // Refresh list after deletion
          } catch (error) {
            console.error('Error deleting recap:', error);
          }
        }
      };
      
      // Action Items container (if there are any)
      let actionItemsContainer = null;
      if (data.actionItems && data.actionItems.length > 0) {
        actionItemsContainer = document.createElement('div');
        actionItemsContainer.className = 'action-items-container';
        actionItemsContainer.style.marginTop = '15px'; // Add some space after subjects
        
        const actionItemsTitle = document.createElement('div');
        actionItemsTitle.className = 'action-items-title';
        actionItemsTitle.textContent = 'Action Items';
        actionItemsContainer.appendChild(actionItemsTitle);
        
        const actionItemsList = document.createElement('ul');
        actionItemsList.className = 'action-items-list';
        
        // Add each action item as a bullet point
        data.actionItems.forEach(item => {
          const listItem = document.createElement('li');
          
          // Highlight matching text if query provided
          if (highlightQuery && highlightQuery.trim() !== '') {
            listItem.innerHTML = highlightText(item, highlightQuery);
          } else {
            listItem.textContent = item;
          }
          
          actionItemsList.appendChild(listItem);
        });
        
        actionItemsContainer.appendChild(actionItemsList);
      }
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Assemble the box
      box.appendChild(title);
      box.appendChild(dateDisplay);
      box.appendChild(subjectsContainer);
      if (actionItemsContainer) box.appendChild(actionItemsContainer);
      box.appendChild(buttonContainer);
      
      // Add box to list
      item.appendChild(box);
      return item;
    }
    
    function getSubjectColor(subject) {
      const colors = {
        'Math': '#4285F4',
        'Science': '#0F9D58',
        'English': '#DB4437',
        'Filipino': '#F4B400',
        'MAPEH': '#AA47BC',
        'Research': '#7E57C2',
        'Analytic': '#42A5F5',
        'Electronics': '#66BB6A',
        'Values': '#8D6E63',
        'Araling': '#8D6E63',
        'Homeroom': '#009688'
      };
      
      return colors[subject] || '#888888';
    }
    
    function promptEditRecap(data) {
      // Set current recap ID
      currentRecapId = data.id;
      
      // Set date value
      const recapDate = data.date.toDate ? data.date.toDate() : new Date(data.date);
      document.getElementById('recap-date').value = formatDateForInput(recapDate);
      
      // Clear all textareas first
      const subjectTextareas = document.querySelectorAll('[id^="recap-subject-"]');
      subjectTextareas.forEach(textarea => {
        textarea.value = '';
      });
      
      // Reset action items
      document.getElementById('recap-action-items').value = '';
      
      // Set values for existing subjects
      if (data.subjects) {
        const subjectMapping = {
          'Math': 'math',
          'Science': 'science',
          'English': 'english',
          'Filipino': 'filipino',
          'MAPEH/Music': 'mapeh-music',
          'MAPEH/Arts': 'mapeh-arts',
          'MAPEH/PE': 'mapeh-pe',
          'MAPEH/Health': 'mapeh-health',
          'Research 2': 'research',
          'Analytic Geometry': 'geometry',
          'Electronics and Robotics': 'electronics',
          'Values': 'values',
          'Araling Panlipunan': 'araling',
          'Homeroom': 'homeroom'
        };
        
        Object.keys(data.subjects).forEach(subject => {
          const fieldId = subjectMapping[subject];
          if (fieldId) {
            document.getElementById(`recap-subject-${fieldId}`).value = data.subjects[subject];
          }
        });
      }
      
      // Set action items if they exist
      if (data.actionItems && Array.isArray(data.actionItems)) {
        document.getElementById('recap-action-items').value = data.actionItems.join('\n');
      }
      
      // Update modal title and button
      document.getElementById('recap-modal-title').textContent = 'Edit Recap';
      document.getElementById('recap-modal-submit').textContent = 'Update';
      
      // Show modal
      showRecapModal(true);
    }

    // Image preview functions
    function showImagePreview(imageUrl) {
      const overlay = document.getElementById('image-preview-overlay');
      const image = document.getElementById('image-preview');
      
      // Set the image source
      image.src = imageUrl;
      
      // Show the overlay
      overlay.style.display = 'flex';
      
      // Prevent scrolling of the background
      document.body.style.overflow = 'hidden';
    }
    
    function closeImagePreview() {
      const overlay = document.getElementById('image-preview-overlay');
      overlay.style.display = 'none';
      
      // Re-enable scrolling
      document.body.style.overflow = '';
    }

    // Global variables for schedules
    let allSchedulesData = [];
    let currentScheduleId = null;
    let currentScheduleSearchQuery = '';
    let currentScheduleDateFilter = '';
    let currentScheduleSortField = 'date';
    let currentScheduleSortDirection = 'asc';

    // Schedule functions
    function showScheduleModal(isEdit = false) {
      // Reset the form if not editing
      if (!isEdit) {
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('schedule-date').value = formatDateForInput(tomorrow);
        
        // Clear all subject textareas
        const subjectTextareas = document.querySelectorAll('[id^="schedule-subject-"]');
        subjectTextareas.forEach(textarea => {
          textarea.value = '';
        });
        
        // Reset edit state
        currentScheduleId = null;
        
        // Update modal title and button
        document.getElementById('schedule-modal-title').textContent = 'New Schedule Entry';
        document.getElementById('schedule-modal-submit').textContent = 'Add';
      }
      
      // Show the modal
      showModal('schedule-modal');
      document.getElementById('schedule-date').focus();
    }
    
    function closeScheduleModal() {
      hideModal('schedule-modal');
    }
    
    async function submitSchedule() {
      const dateInput = document.getElementById('schedule-date');
      const date = dateInput.value;
      
      if (!date) {
        alert("Please select a date for the schedule entry.");
        return;
      }
      
      // Collect all subject data
      const subjects = {};
      const subjectIDs = [
        { key: 'math', name: 'Math' },
        { key: 'science', name: 'Science' },
        { key: 'english', name: 'English' },
        { key: 'filipino', name: 'Filipino' },
        { key: 'mapeh-music', name: 'MAPEH/Music' },
        { key: 'mapeh-arts', name: 'MAPEH/Arts' },
        { key: 'mapeh-pe', name: 'MAPEH/PE' },
        { key: 'mapeh-health', name: 'MAPEH/Health' },
        { key: 'research', name: 'Research 2' },
        { key: 'geometry', name: 'Analytic Geometry' },
        { key: 'electronics', name: 'Electronics and Robotics' },
        { key: 'values', name: 'Values' },
        { key: 'araling', name: 'Araling Panlipunan' },
        { key: 'homeroom', name: 'Homeroom' }
      ];
      
      // Check if at least one subject has content
      let hasContent = false;
      
      subjectIDs.forEach(subject => {
        const content = document.getElementById(`schedule-subject-${subject.key}`).value.trim();
        if (content) {
          hasContent = true;
          subjects[subject.name] = content;
        }
      });
      
      if (!hasContent) {
        alert("Please add content for at least one subject.");
        return;
      }
      
      try {
        if (currentScheduleId) {
          // Update existing schedule
          await db.collection('schedules').doc(currentScheduleId).update({
            date: new Date(date),
            subjects: subjects,
            lastUpdated: new Date()
          });
        } else {
          // Create new schedule
          await db.collection('schedules').add({
            date: new Date(date),
            subjects: subjects,
            created: new Date(),
            archived: false
          });
        }
        
        closeScheduleModal();
        await loadSchedules(); // Refresh list after adding/updating
      } catch (error) {
        console.error('Error saving schedule:', error);
        alert("Error saving schedule: " + error.message);
      }
    }
    
    async function loadSchedules() {
      try {
        console.log("Loading schedules...");
        // Get all schedules
        const snapshot = await db.collection('schedules').orderBy('date', 'asc').get();
        allSchedulesData = []; // Reset the array
        
        snapshot.forEach(doc => {
          const data = doc.data();
          allSchedulesData.push({
            id: doc.id,
            ...data
          });
        });
        
        console.log("Schedules loaded:", allSchedulesData.length);
        
        // Apply any existing filters
        applyScheduleFilters();
      } catch (error) {
        console.error('Error loading schedules:', error);
      }
    }
    
    function filterSchedules(query) {
      currentScheduleSearchQuery = query || '';
      applyScheduleFilters();
    }
    
    function filterSchedulesByDate(date) {
      currentScheduleDateFilter = date || '';
      updateScheduleActiveFilters();
      applyScheduleFilters();
    }
    
    function applyScheduleFilters() {
      let filtered = [...allSchedulesData];
      
      // Apply date filter if selected
      if (currentScheduleDateFilter) {
        const filterDate = new Date(currentScheduleDateFilter);
        filterDate.setHours(0, 0, 0, 0); // Reset time to start of day
        
        filtered = filtered.filter(schedule => {
          const scheduleDate = schedule.date.toDate ? schedule.date.toDate() : new Date(schedule.date);
          scheduleDate.setHours(0, 0, 0, 0); // Reset time to start of day
          return scheduleDate.getTime() === filterDate.getTime();
        });
      }
      
      // Apply search query if present
      if (currentScheduleSearchQuery.trim() !== '') {
        const query = currentScheduleSearchQuery.toLowerCase().trim();
        filtered = filtered.filter(schedule => {
          // Check if any subject content matches the query
          if (schedule.subjects) {
            for (const subject in schedule.subjects) {
              if (schedule.subjects[subject].toLowerCase().includes(query) || 
                  subject.toLowerCase().includes(query)) {
                return true;
              }
            }
          }
          
          // No matches found
          return false;
        });
      }
      
      // Sort the filtered results
      filtered = sortSchedules(filtered);
      
      // Update the active filters display
      updateScheduleActiveFilters();
      
      // Render the filtered schedules
      renderSchedules(filtered, currentScheduleSearchQuery);
    }
    
    function sortSchedules(schedules) {
      return [...schedules].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentScheduleSortField) {
          case 'date':
            // Handle null dates
            if (!a.date && !b.date) return 0;
            if (!a.date) return currentScheduleSortDirection === 'asc' ? 1 : -1;
            if (!b.date) return currentScheduleSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const dateA = a.date.toDate ? a.date.toDate() : new Date(a.date);
            const dateB = b.date.toDate ? b.date.toDate() : new Date(b.date);
            
            valueA = dateA.getTime();
            valueB = dateB.getTime();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentScheduleSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentScheduleSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentScheduleSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }
    
    function setScheduleSortField(field) {
      currentScheduleSortField = field;
      applyScheduleFilters();
    }
    
    function setScheduleSortDirection(direction) {
      currentScheduleSortDirection = direction;
      applyScheduleFilters();
    }
    
    function updateScheduleActiveFilters() {
      const activeFiltersContainer = document.getElementById('schedule-active-filters');
      // Check if the element exists before trying to update it
      if (!activeFiltersContainer) return;
      
      activeFiltersContainer.innerHTML = '';
      
      if (currentScheduleDateFilter) {
        const filterDate = new Date(currentScheduleDateFilter);
        const formattedDate = filterDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Date: ${formattedDate} <button onclick="clearScheduleDateFilter()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
      
      // Add search filter if present
      if (currentScheduleSearchQuery.trim() !== '') {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Search: ${currentScheduleSearchQuery} <button onclick="clearScheduleSearch()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }
    
    function clearScheduleDateFilter() {
      currentScheduleDateFilter = '';
      const dateFilter = document.getElementById('schedule-date-filter');
      if (dateFilter) dateFilter.value = '';
      applyScheduleFilters();
    }
    
    function clearScheduleSearch() {
      const searchInput = document.getElementById('schedule-search-input');
      if (searchInput) searchInput.value = '';
      currentScheduleSearchQuery = '';
      applyScheduleFilters();
    }
    
    function renderSchedules(schedules, highlightText = '') {
      console.log("Rendering schedules:", schedules.length);
      
      // Count active and archived schedules
      const activeSchedules = schedules.filter(s => !s.archived);
      const archivedSchedules = schedules.filter(s => s.archived);
      
      console.log("Active schedules:", activeSchedules.length, "Archived schedules:", archivedSchedules.length);
      
      // Render all active schedules section
      const allSection = document.getElementById('all-schedules');
      // Check if the element exists before trying to update it
      if (!allSection) {
        console.error("all-schedules element not found!");
        return;
      }
      
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'Upcoming Schedule';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeSchedules.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'schedule-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active schedules
      if (activeSchedules.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No schedules match your search' : 'No schedules';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active schedules
        activeSchedules.forEach(data => {
          allList.appendChild(createScheduleElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived schedules
      if (archivedSchedules.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-schedules');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-schedules';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedSchedules.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'schedule-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived schedules
        archivedSchedules.forEach(data => {
          archivedList.appendChild(createScheduleElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived schedules
        const archivedSection = document.getElementById('archived-schedules');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }
    
    function createScheduleElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'schedule-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('schedule-archived');
      }
      
      // Title (Date)
      const title = document.createElement('h3');
      title.className = 'schedule-title';
      
      // Format the date
      const scheduleDate = data.date.toDate ? data.date.toDate() : new Date(data.date);
      title.textContent = formatDateForDisplay(scheduleDate);
      
      // Date display
      const dateDisplay = document.createElement('span');
      dateDisplay.className = 'schedule-date';
      
      // Calculate days from today
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dateCopy = new Date(scheduleDate);
      dateCopy.setHours(0, 0, 0, 0);
      const diffTime = dateCopy.getTime() - today.getTime();
      const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
      
      // Format days display
      if (diffDays === 0) {
        dateDisplay.textContent = 'Today';
      } else if (diffDays === 1) {
        dateDisplay.textContent = 'Tomorrow';
      } else if (diffDays > 1) {
        dateDisplay.textContent = `In ${diffDays} days`;
      } else {
        dateDisplay.textContent = `${Math.abs(diffDays)} days ago`;
      }
      
      // Subjects container
      const subjectsContainer = document.createElement('div');
      subjectsContainer.className = 'schedule-subjects';
      
      // Define all possible subjects to ensure they all appear
      const allSubjects = [
        'Math', 'Science', 'English', 'Filipino', 
        'MAPEH/Music', 'MAPEH/Arts', 'MAPEH/PE', 'MAPEH/Health',
        'Research 2', 'Analytic Geometry', 'Electronics and Robotics',
        'Values', 'Araling Panlipunan', 'Homeroom'
      ];
      
      // Process all subjects
      allSubjects.forEach(subject => {
        const subjectElement = document.createElement('div');
        subjectElement.className = 'schedule-subject';
        
        // Get the subject category for styling
        const subjectCategory = subject.split('/')[0];
        subjectElement.style.borderLeftColor = getSubjectColor(subjectCategory);
        
        // Subject title
        const subjectTitle = document.createElement('div');
        subjectTitle.className = 'schedule-subject-title';
        
        // Subject name
        const subjectName = document.createElement('div');
        subjectName.textContent = subject;
        
        // Subject badge (optional)
        const subjectBadge = document.createElement('span');
        subjectBadge.style.backgroundColor = getSubjectColor(subjectCategory);
        subjectBadge.textContent = subjectCategory;
        
        subjectTitle.appendChild(subjectName);
        subjectTitle.appendChild(subjectBadge);
        
        // Subject content
        const subjectContent = document.createElement('div');
        subjectContent.className = 'schedule-subject-content';
        
        // Check if there's content for this subject
        if (data.subjects && data.subjects[subject] && data.subjects[subject].trim()) {
          // Highlight matching text if query provided
          if (highlightQuery && highlightQuery.trim() !== '') {
            subjectContent.innerHTML = highlightText(data.subjects[subject], highlightQuery);
          } else {
            subjectContent.textContent = data.subjects[subject];
          }
        } else {
          subjectContent.innerHTML = '<span class="empty-content">No data</span>';
        }
        
        subjectElement.appendChild(subjectTitle);
        subjectElement.appendChild(subjectContent);
        subjectsContainer.appendChild(subjectElement);
      });
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => {
        promptEditSchedule(data);
      };
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = async () => {
        try {
          await db.collection('schedules').doc(data.id).update({
            archived: !data.archived
          });
          await loadSchedules(); // Refresh list after status change
        } catch (error) {
          console.error('Error updating archive status:', error);
        }
      };
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = async () => {
        if (confirm(`Delete this schedule for ${title.textContent}?`)) {
          try {
            await db.collection('schedules').doc(data.id).delete();
            await loadSchedules(); // Refresh list after deletion
          } catch (error) {
            console.error('Error deleting schedule:', error);
          }
        }
      };
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Assemble the box
      box.appendChild(title);
      box.appendChild(dateDisplay);
      box.appendChild(subjectsContainer);
      box.appendChild(buttonContainer);
      
      // Add box to list
      item.appendChild(box);
      return item;
    }
    
    function promptEditSchedule(data) {
      // Set current schedule ID
      currentScheduleId = data.id;
      
      // Set date value
      const scheduleDate = data.date.toDate ? data.date.toDate() : new Date(data.date);
      document.getElementById('schedule-date').value = formatDateForInput(scheduleDate);
      
      // Clear all textareas first
      const subjectTextareas = document.querySelectorAll('[id^="schedule-subject-"]');
      subjectTextareas.forEach(textarea => {
        textarea.value = '';
      });
      
      // Set values for existing subjects
      if (data.subjects) {
        const subjectMapping = {
          'Math': 'math',
          'Science': 'science',
          'English': 'english',
          'Filipino': 'filipino',
          'MAPEH/Music': 'mapeh-music',
          'MAPEH/Arts': 'mapeh-arts',
          'MAPEH/PE': 'mapeh-pe',
          'MAPEH/Health': 'mapeh-health',
          'Research 2': 'research',
          'Analytic Geometry': 'geometry',
          'Electronics and Robotics': 'electronics',
          'Values': 'values',
          'Araling Panlipunan': 'araling',
          'Homeroom': 'homeroom'
        };
        
        Object.keys(data.subjects).forEach(subject => {
          const fieldId = subjectMapping[subject];
          if (fieldId) {
            document.getElementById(`schedule-subject-${fieldId}`).value = data.subjects[subject];
          }
        });
      }
      
      // Update modal title and button
      document.getElementById('schedule-modal-title').textContent = 'Edit Schedule';
      document.getElementById('schedule-modal-submit').textContent = 'Update';
      
      // Show modal
      showScheduleModal(true);
    }

    document.addEventListener('DOMContentLoaded', () => {
      showSection('home'); // Show home by default
      
      // Set the home nav link as active initially
      const homeNavLink = document.querySelector('.nav-link[onclick*="showSection(\'home\')"]');
      if (homeNavLink) {
        setActiveNavItem(homeNavLink);
      }
      
      // Hide all modals initially
      const modals = [
        'assignment-modal',
        'resource-modal',
        'announcement-modal',
        'quicklink-modal',
        'recap-modal',
        'schedule-modal'
      ];
      
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          modal.style.background = 'rgba(0,0,0,0.5)';
          modal.style.zIndex = '1000';
        }
      });
      
      // Set up image preview event listeners
      const imagePreviewOverlay = document.getElementById('image-preview-overlay');
      const closeButton = document.getElementById('image-preview-close');
      
      // Close when clicking the overlay or close button
      imagePreviewOverlay.addEventListener('click', function(e) {
        // Only close if clicking the overlay itself, not the image
        if (e.target === imagePreviewOverlay) {
          closeImagePreview();
        }
      });
      
      closeButton.addEventListener('click', closeImagePreview);
      
      // Close on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && imagePreviewOverlay.style.display === 'flex') {
          closeImagePreview();
        }
      });
      
      // Initialize only the data for the home page initially
      // The other sections will load their data when they are shown
      if (db) {
        // We don't need to load anything for home page
        // Data for other sections will be loaded when those sections are shown
      }
    });

    // Quick Links functions
    let allQuickLinks = [];
    let currentQuickLinkSearchQuery = '';
    let currentQuickLinkSubjectFilter = '';
    let currentQuickLinkSortField = 'created';
    let currentQuickLinkSortDirection = 'asc';
    let currentQuickLinkId = null;
    let isEditingQuickLink = false;

    // Load quick links from Firebase
    async function loadQuickLinks() {
      try {
        const quickLinksRef = db.collection('quickLinks');
        const quickLinksSnapshot = await quickLinksRef.get();
        
        allQuickLinks = [];
        quickLinksSnapshot.forEach(doc => {
          allQuickLinks.push({ id: doc.id, ...doc.data() });
        });
        
        // Populate subject filter options
        populateQuickLinkSubjectOptions();
        
        // Apply filters and render
        applyQuickLinkFilters();
      } catch (error) {
        console.error("Error loading quick links:", error);
      }
    }

    // Populate subject filter options
    function populateQuickLinkSubjectOptions() {
      const subjectFilter = document.getElementById('quicklink-subject-filter');
      const subjects = new Set();
      
      // Add all unique subjects
      allQuickLinks.forEach(link => {
        if (link.subject) {
          subjects.add(link.subject);
        }
      });
      
      // Clear existing options except the first one (All Subjects)
      while (subjectFilter.options.length > 1) {
        subjectFilter.remove(1);
      }
      
      // Add options for each subject
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectFilter.appendChild(option);
      });
    }

    // Filter quick links by search query
    function filterQuickLinks(query) {
      currentQuickLinkSearchQuery = query;
      applyQuickLinkFilters();
    }

    // Filter quick links by subject
    function filterQuickLinksBySubject(subject) {
      currentQuickLinkSubjectFilter = subject;
      updateQuickLinkActiveFilters();
      applyQuickLinkFilters();
    }

    // Apply all filters and sorting
    function applyQuickLinkFilters() {
      let filtered = [...allQuickLinks];
      
      // Apply subject filter
      if (currentQuickLinkSubjectFilter) {
        filtered = filtered.filter(link => link.subject === currentQuickLinkSubjectFilter);
      }
      
      // Apply search filter
      if (currentQuickLinkSearchQuery.trim() !== '') {
        const query = currentQuickLinkSearchQuery.toLowerCase();
        filtered = filtered.filter(link => {
          return (link.name && link.name.toLowerCase().includes(query)) || 
                 (link.subject && link.subject.toLowerCase().includes(query)) ||
                 (link.url && link.url.toLowerCase().includes(query));
        });
      }
      
      // Apply sorting
      filtered = sortQuickLinks(filtered);
      
      // Update UI
      renderQuickLinks(filtered, currentQuickLinkSearchQuery);
    }

    // Sort quick links
    function sortQuickLinks(quickLinks) {
      return [...quickLinks].sort((a, b) => {
        let valueA, valueB;
        
        // Get the values to compare based on sort field
        switch (currentQuickLinkSortField) {
          case 'name':
            valueA = (a.name || '').toLowerCase();
            valueB = (b.name || '').toLowerCase();
            break;
          case 'subject':
            valueA = (a.subject || '').toLowerCase();
            valueB = (b.subject || '').toLowerCase();
            break;
          case 'created':
          default:
            // Handle null dates
            if (!a.created && !b.created) return 0;
            if (!a.created) return currentQuickLinkSortDirection === 'asc' ? 1 : -1;
            if (!b.created) return currentQuickLinkSortDirection === 'asc' ? -1 : 1;
            
            // Convert Firestore timestamps if needed
            const createdA = a.created.toDate ? a.created.toDate() : new Date(a.created);
            const createdB = b.created.toDate ? b.created.toDate() : new Date(b.created);
            
            valueA = createdA.getTime();
            valueB = createdB.getTime();
        }
        
        // Compare based on direction
        if (currentQuickLinkSortDirection === 'asc') {
          return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
        } else {
          return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
        }
      });
    }

    // Set sort field
    function setQuickLinkSortField(field) {
      currentQuickLinkSortField = field;
      applyQuickLinkFilters();
    }

    // Set sort direction
    function setQuickLinkSortDirection(direction) {
      currentQuickLinkSortDirection = direction;
      applyQuickLinkFilters();
    }

    // Update active filters UI
    function updateQuickLinkActiveFilters() {
      const activeFiltersContainer = document.getElementById('quicklink-active-filters');
      activeFiltersContainer.innerHTML = '';
      
      if (currentQuickLinkSubjectFilter) {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Subject: ${currentQuickLinkSubjectFilter} <button onclick="clearQuickLinkSubjectFilter()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
      
      // Add search filter if present
      if (currentQuickLinkSearchQuery.trim() !== '') {
        const filterTag = document.createElement('span');
        filterTag.className = 'active-filter';
        filterTag.innerHTML = `Search: ${currentQuickLinkSearchQuery} <button onclick="clearQuickLinkSearch()">×</button>`;
        activeFiltersContainer.appendChild(filterTag);
      }
    }

    // Clear subject filter
    function clearQuickLinkSubjectFilter() {
      currentQuickLinkSubjectFilter = '';
      document.getElementById('quicklink-subject-filter').value = '';
      applyQuickLinkFilters();
    }

    // Clear search
    function clearQuickLinkSearch() {
      const searchInput = document.getElementById('quicklink-search-input');
      searchInput.value = '';
      currentQuickLinkSearchQuery = '';
      applyQuickLinkFilters();
    }

    // Render quick links
    function renderQuickLinks(quickLinks, highlightText = '') {
      // Count pinned, active, and archived quick links
      const pinnedQuickLinks = quickLinks.filter(link => link.pinned && !link.archived);
      const activeQuickLinks = quickLinks.filter(link => !link.archived); // Include all non-archived links
      const archivedQuickLinks = quickLinks.filter(link => link.archived);
      
      // Render pinned quick links section
      const pinnedSection = document.getElementById('pinned-quicklinks');
      pinnedSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const pinnedHeader = document.createElement('div');
      pinnedHeader.className = 'section-header';
      const pinnedTitle = document.createElement('h2');
      pinnedTitle.textContent = 'Pinned';
      const pinnedCount = document.createElement('span');
      pinnedCount.className = 'section-count';
      pinnedCount.textContent = pinnedQuickLinks.length;
      pinnedHeader.appendChild(pinnedTitle);
      pinnedHeader.appendChild(pinnedCount);
      pinnedSection.appendChild(pinnedHeader);
      
      // Create list container
      const pinnedList = document.createElement('ul');
      pinnedList.className = 'quicklink-list';
      pinnedList.style.listStyleType = 'none';
      pinnedList.style.paddingLeft = '0';
      
      // Display message if no pinned quick links
      if (pinnedQuickLinks.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No pinned quick links match your search' : 'No pinned quick links';
        pinnedSection.appendChild(emptyMessage);
      } else {
        // Render pinned quick links
        pinnedQuickLinks.forEach(data => {
          pinnedList.appendChild(createQuickLinkElement(data, highlightText));
        });
      }
      
      pinnedSection.appendChild(pinnedList);
      
      // Render all active quick links section
      const allSection = document.getElementById('all-quicklinks');
      allSection.innerHTML = ''; // Clear section
      
      // Add section header with count
      const allHeader = document.createElement('div');
      allHeader.className = 'section-header';
      const allTitle = document.createElement('h2');
      allTitle.textContent = 'All Quick Links';
      const allCount = document.createElement('span');
      allCount.className = 'section-count';
      allCount.textContent = activeQuickLinks.length;
      allHeader.appendChild(allTitle);
      allHeader.appendChild(allCount);
      allSection.appendChild(allHeader);
      
      // Create list container
      const allList = document.createElement('ul');
      allList.className = 'quicklink-list';
      allList.style.listStyleType = 'none';
      allList.style.paddingLeft = '0';
      
      // Display message if no active quick links
      if (activeQuickLinks.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty-message';
        emptyMessage.textContent = highlightText ? 'No quick links match your search' : 'No quick links';
        allSection.appendChild(emptyMessage);
      } else {
        // Render all active quick links
        activeQuickLinks.forEach(data => {
          allList.appendChild(createQuickLinkElement(data, highlightText));
        });
      }
      
      allSection.appendChild(allList);
      
      // Create archived section if there are any archived quick links
      if (archivedQuickLinks.length > 0) {
        // Create archived section container if it doesn't exist
        let archivedSection = document.getElementById('archived-quicklinks');
        if (!archivedSection) {
          archivedSection = document.createElement('div');
          archivedSection.id = 'archived-quicklinks';
          allSection.parentNode.insertBefore(archivedSection, allSection.nextSibling);
        } else {
          archivedSection.innerHTML = ''; // Clear existing content
        }
        
        // Add section header with count
        const archivedHeader = document.createElement('div');
        archivedHeader.className = 'section-header';
        const archivedTitle = document.createElement('h2');
        archivedTitle.textContent = 'Archived';
        const archivedCount = document.createElement('span');
        archivedCount.className = 'section-count';
        archivedCount.textContent = archivedQuickLinks.length;
        archivedHeader.appendChild(archivedTitle);
        archivedHeader.appendChild(archivedCount);
        archivedSection.appendChild(archivedHeader);
        
        // Create list container
        const archivedList = document.createElement('ul');
        archivedList.className = 'quicklink-list';
        archivedList.style.listStyleType = 'none';
        archivedList.style.paddingLeft = '0';
        
        // Render archived quick links
        archivedQuickLinks.forEach(data => {
          archivedList.appendChild(createQuickLinkElement(data, highlightText));
        });
        
        archivedSection.appendChild(archivedList);
      } else {
        // Remove archived section if it exists but there are no archived quick links
        const archivedSection = document.getElementById('archived-quicklinks');
        if (archivedSection) {
          archivedSection.remove();
        }
      }
    }

    // Create quick link element
    function createQuickLinkElement(data, highlightQuery = '') {
      const item = document.createElement('li');
      
      // Create box container
      const box = document.createElement('div');
      box.className = 'quicklink-box';
      box.style.position = 'relative'; // To anchor buttons
      
      // Apply archived styling if needed
      if (data.archived) {
        box.classList.add('quicklink-archived');
      }
      
      // Apply pinned styling if needed
      if (data.pinned) {
        box.classList.add('quicklink-pinned');
      }
      
      // Title
      const title = document.createElement('h3');
      title.className = 'quicklink-title';
      if (highlightQuery && data.name) {
        title.innerHTML = highlightText(data.name || 'Untitled', highlightQuery);
      } else {
        title.textContent = data.name || 'Untitled';
      }
      
      // Subject (if available)
      let subject = null;
      if (data.subject) {
        subject = document.createElement('span');
        subject.className = 'quicklink-subject';
        if (data.subject === "All Subjects") {
          subject.classList.add('subject-All');
        } else {
          const subjectClass = 'subject-' + data.subject.split('/')[0].replace(/\s+/g, '');
          subject.classList.add(subjectClass);
        }
        if (highlightQuery) {
          subject.innerHTML = highlightText(data.subject, highlightQuery);
        } else {
          subject.textContent = data.subject;
        }
      }
      
      // Link
      let quickLinkElement = document.createElement('div');
      quickLinkElement.className = 'quicklink-link';
      
      const link = document.createElement('a');
      link.target = '_blank';
      
      if (data.type === 'file') {
        // File resource
        link.href = data.fileUrl || '#';
        link.innerHTML = '<span class="icon">📄</span> ' + (data.filename || 'Download File');
      } else {
        // URL resource
        link.href = data.url || '#';
        link.innerHTML = '<span class="icon">🔗</span> ' + (data.url || 'Open Link');
      }
      
      quickLinkElement.appendChild(link);
      
      // Create button container for consistent positioning
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container mt-3 d-flex justify-content-end gap-2';
      buttonContainer.style.marginTop = '10px';
      
      // Edit Button
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-primary';
      editBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit';
      editBtn.onclick = () => editQuickLink(data.id);
      
      // Pin/Unpin Button
      const pinBtn = document.createElement('button');
      pinBtn.className = data.pinned ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-outline-warning';
      pinBtn.innerHTML = data.pinned ? '<i class="bi bi-pin-fill"></i> Unpin' : '<i class="bi bi-pin"></i> Pin';
      pinBtn.onclick = () => toggleQuickLinkPin(data.id, !data.pinned);
      
      // Archive/Unarchive Button
      const archiveBtn = document.createElement('button');
      archiveBtn.className = data.archived ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-secondary';
      archiveBtn.innerHTML = data.archived ? '<i class="bi bi-arrow-counterclockwise"></i> Unarchive' : '<i class="bi bi-archive"></i> Archive';
      archiveBtn.onclick = () => toggleQuickLinkArchive(data.id, !data.archived);
      
      // Delete Button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-danger';
      deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
      deleteBtn.onclick = () => deleteQuickLink(data.id);
      
      // Add buttons to the container
      buttonContainer.appendChild(editBtn);
      buttonContainer.appendChild(pinBtn);
      buttonContainer.appendChild(archiveBtn);
      buttonContainer.appendChild(deleteBtn);
      
      // Append elements to box
      box.appendChild(title);
      if (subject) box.appendChild(subject);
      box.appendChild(quickLinkElement);
      box.appendChild(buttonContainer);
      
      // Append box to list item
      item.appendChild(box);
      
      return item;
    }

    // Show quick link modal
    function showQuickLinkModal() {
      // Reset form
      document.getElementById('quicklink-input').value = '';
      document.getElementById('quicklink-subject-select').value = '';
      document.getElementById('quicklink-url').value = '';
      document.getElementById('quicklink-file').value = '';
      document.getElementById('quicklink-file-name').textContent = '';
      document.getElementById('quicklink-type-toggle').checked = false;
      document.getElementById('quicklink-url-container').style.display = 'block';
      document.getElementById('quicklink-file-container').style.display = 'none';
      
      // Set title
      document.getElementById('quicklink-modal-title').textContent = 'New Quick Link';
      
      // Set submit button text
      document.getElementById('quicklink-modal-submit').textContent = 'Add';
      
      // Reset editing state
      isEditingQuickLink = false;
      currentQuickLinkId = null;
      
      // Show modal
      showModal('quicklink-modal');
    }

    // Close quick link modal
    function closeQuickLinkModal() {
      hideModal('quicklink-modal');
    }

    // Toggle quick link type (URL/File)
    function toggleQuickLinkType() {
      const isFile = document.getElementById('quicklink-type-toggle').checked;
      document.getElementById('quicklink-url-container').style.display = isFile ? 'none' : 'block';
      document.getElementById('quicklink-file-container').style.display = isFile ? 'block' : 'none';
    }

    // Submit quick link
    async function submitQuickLink() {
      try {
        const name = document.getElementById('quicklink-input').value.trim();
        const subject = document.getElementById('quicklink-subject-select').value;
        const isFile = document.getElementById('quicklink-type-toggle').checked;
        
        if (!name) {
          alert('Please enter a name for the quick link');
          return;
        }
        
        let quickLinkData = {
          name,
          subject: subject || null,
          type: isFile ? 'file' : 'url',
          pinned: false,
          archived: false,
          created: new Date()
        };
        
        if (isFile) {
          // Handle file upload
          const fileInput = document.getElementById('quicklink-file');
          if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select a file');
            return;
          }
          
          const file = fileInput.files[0];
          const storageRef = storage.ref(`quicklink-files/${Date.now()}_${file.name}`);
          
          // Upload file
          const uploadTask = await storageRef.put(file);
          const downloadURL = await uploadTask.ref.getDownloadURL();
          
          quickLinkData.fileUrl = downloadURL;
          quickLinkData.filename = file.name;
        } else {
          // Handle URL
          const url = document.getElementById('quicklink-url').value.trim();
          if (!url) {
            alert('Please enter a URL');
            return;
          }
          
          // Add http:// if not present
          let formattedUrl = url;
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
            formattedUrl = 'https://' + url;
          }
          
          quickLinkData.url = formattedUrl;
        }
        
        if (isEditingQuickLink) {
          // Update existing quick link
          const quickLinkRef = db.collection('quickLinks').doc(currentQuickLinkId);
          
          // Don't overwrite created timestamp and preserve pinned/archived status
          const existingQuickLink = allQuickLinks.find(link => link.id === currentQuickLinkId);
          if (existingQuickLink) {
            quickLinkData.pinned = existingQuickLink.pinned;
            quickLinkData.archived = existingQuickLink.archived;
            quickLinkData.created = existingQuickLink.created;
          }
          
          await quickLinkRef.update(quickLinkData);
        } else {
          // Add new quick link
          await db.collection('quickLinks').add(quickLinkData);
        }
        
        // Close modal and refresh
        closeQuickLinkModal();
        await loadQuickLinks();
      } catch (error) {
        console.error("Error submitting quick link:", error);
        alert("Error saving quick link: " + error.message);
      }
    }

    // Edit quick link
    function editQuickLink(id) {
      const quickLink = allQuickLinks.find(link => link.id === id);
      if (!quickLink) return;
      
      // Set form values
      document.getElementById('quicklink-input').value = quickLink.name || '';
      document.getElementById('quicklink-subject-select').value = quickLink.subject || '';
      
      const isFile = quickLink.type === 'file';
      document.getElementById('quicklink-type-toggle').checked = isFile;
      
      // Show appropriate container
      document.getElementById('quicklink-url-container').style.display = isFile ? 'none' : 'block';
      document.getElementById('quicklink-file-container').style.display = isFile ? 'block' : 'none';
      
      if (isFile) {
        document.getElementById('quicklink-file-name').textContent = quickLink.filename || '';
      } else {
        document.getElementById('quicklink-url').value = quickLink.url || '';
      }
      
      // Set title
      document.getElementById('quicklink-modal-title').textContent = 'Edit Quick Link';
      
      // Set submit button text
      document.getElementById('quicklink-modal-submit').textContent = 'Save';
      
      // Set editing state
      isEditingQuickLink = true;
      currentQuickLinkId = id;
      
      // Show modal
      document.getElementById('quicklink-modal').style.display = 'flex';
    }

    // Toggle quick link pin status
    async function toggleQuickLinkPin(id, pinned) {
      try {
        const quickLinkRef = db.collection('quickLinks').doc(id);
        await quickLinkRef.update({ pinned });
        await loadQuickLinks(); // Refresh list after status change
      } catch (error) {
        console.error("Error updating quick link pin status:", error);
      }
    }

    // Toggle quick link archive status
    async function toggleQuickLinkArchive(id, archived) {
      try {
        const quickLinkRef = db.collection('quickLinks').doc(id);
        await quickLinkRef.update({ archived });
        await loadQuickLinks(); // Refresh list after status change
      } catch (error) {
        console.error("Error updating quick link archive status:", error);
      }
    }

    // Delete quick link
    async function deleteQuickLink(id) {
      if (!confirm('Are you sure you want to delete this quick link?')) return;
      
      try {
        const quickLink = allQuickLinks.find(link => link.id === id);
        
        // If it's a file, delete from storage too
        if (quickLink && quickLink.type === 'file' && quickLink.fileUrl) {
          try {
            const fileRef = storage.refFromURL(quickLink.fileUrl);
            await fileRef.delete();
          } catch (storageError) {
            console.error("Error deleting file from storage:", storageError);
            // Continue with deleting the document even if file deletion fails
          }
        }
        
        // Delete from Firestore
        const quickLinkRef = db.collection('quickLinks').doc(id);
        await quickLinkRef.delete();
        await loadQuickLinks(); // Refresh list after deletion
      } catch (error) {
        console.error("Error deleting quick link:", error);
      }
    }
  </script>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand">
        <i class="bi bi-mortarboard-fill me-2"></i>Student Hub
      </span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('home'); setActiveNavItem(this);">
              <i class="bi bi-house-door me-1"></i>Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('schedule'); setActiveNavItem(this);">
              <i class="bi bi-calendar-week me-1"></i>Schedule
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('assignments'); setActiveNavItem(this);">
              <i class="bi bi-clipboard-check me-1"></i>Assignments
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('resources'); setActiveNavItem(this);">
              <i class="bi bi-journal-bookmark me-1"></i>Resources
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('announcements'); setActiveNavItem(this);">
              <i class="bi bi-megaphone me-1"></i>Announcements
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('quick-links'); setActiveNavItem(this);">
              <i class="bi bi-link-45deg me-1"></i>Quick Links
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="#" onclick="showSection('recaps'); setActiveNavItem(this);">
              <i class="bi bi-card-text me-1"></i>Recaps
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="home" class="section container">
    <div class="card">
      <div class="card-body text-center">
        <h1 class="mb-4">Welcome to Student Hub</h1>
        <p class="lead">Your all-in-one platform for managing school activities</p>
        <div class="row mt-5">
          <div class="col-md-4 mb-4">
            <div class="card h-100 border-primary">
              <div class="card-body text-center">
                <i class="bi bi-calendar-week text-primary" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Manage Schedule</h5>
                <p>Plan your classes and track upcoming events</p>
                <button class="btn btn-outline-primary" onclick="showSection('schedule')">Go to Schedule</button>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card h-100 border-success">
              <div class="card-body text-center">
                <i class="bi bi-clipboard-check text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Track Assignments</h5>
                <p>Keep track of homework and projects</p>
                <button class="btn btn-outline-success" onclick="showSection('assignments')">Go to Assignments</button>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card h-100 border-info">
              <div class="card-body text-center">
                <i class="bi bi-journal-bookmark text-info" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Access Resources</h5>
                <p>Find study materials and important links</p>
                <button class="btn btn-outline-info" onclick="showSection('resources')">Go to Resources</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="schedule" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Schedule</h1>
      <button class="btn btn-primary" onclick="showScheduleModal()">
        <i class="bi bi-plus-circle me-1"></i>New Schedule Entry
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="schedule-search-input" placeholder="Search schedules..." oninput="filterSchedules(this.value)" />
          <button onclick="clearScheduleSearch()">✕</button>
        </div>
      </div>
      
      <!-- Date filter -->
      <div class="controls-group">
        <div class="filter-container">
          <span class="controls-label">Filter by date:</span>
          <input type="date" id="schedule-date-filter" onchange="filterSchedulesByDate(this.value)" />
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="schedule-sort-field" onchange="setScheduleSortField(this.value)">
            <option value="date" selected>Date</option>
            <option value="created">Date Created</option>
          </select>
          <select id="schedule-sort-direction" onchange="setScheduleSortDirection(this.value)">
            <option value="asc" selected>Ascending</option>
            <option value="desc">Descending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Active filters -->
    <div id="schedule-active-filters"></div>
    
    <!-- All schedules section -->
    <div id="all-schedules">
      <!-- Section header will be added by JavaScript -->
      <ul class="schedule-list"></ul>
    </div>
  </div>

  <div id="assignments" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Assignments</h1>
      <button class="btn btn-primary" onclick="promptNewAssignment()">
        <i class="bi bi-plus-circle me-1"></i>New Assignment
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="search-input" placeholder="Search assignments..." oninput="filterAssignments(this.value)" />
          <button onclick="clearSearch()">✕</button>
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="sort-field" onchange="setSortField(this.value)">
            <option value="created">Date Created</option>
            <option value="deadline">Deadline</option>
            <option value="name">Name</option>
            <option value="subject">Subject</option>
          </select>
          <select id="sort-direction" onchange="setSortDirection(this.value)">
            <option value="desc">Descending</option>
            <option value="asc" selected>Ascending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Subject filter -->
    <div class="filter-container">
      <span class="filter-label">Filter by:</span>
      <select id="subject-filter" onchange="filterBySubject(this.value)">
        <option value="">All Subjects</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    
    <!-- Active filters -->
    <div id="active-filters"></div>
    
    <!-- Starred assignments section -->
    <div id="starred-assignments">
      <!-- Section header will be added by JavaScript -->
      <ul class="assignment-list"></ul>
    </div>
    
    <!-- All assignments section -->
    <div id="all-assignments">
      <!-- Section header will be added by JavaScript -->
      <ul class="assignment-list"></ul>
    </div>
  </div>

  <div id="resources" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Resources</h1>
      <button class="btn btn-primary" onclick="showResourceModal()">
        <i class="bi bi-plus-circle me-1"></i>New Resource
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="resource-search-input" placeholder="Search resources..." oninput="filterResources(this.value)" />
          <button onclick="clearResourceSearch()">✕</button>
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="resource-sort-field" onchange="setResourceSortField(this.value)">
            <option value="created">Date Created</option>
            <option value="name">Name</option>
            <option value="subject">Subject</option>
          </select>
          <select id="resource-sort-direction" onchange="setResourceSortDirection(this.value)">
            <option value="desc">Descending</option>
            <option value="asc" selected>Ascending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Subject filter -->
    <div class="filter-container">
      <span class="filter-label">Filter by:</span>
      <select id="resource-subject-filter" onchange="filterResourcesBySubject(this.value)">
        <option value="">All Subjects</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    
    <!-- Active filters -->
    <div id="resource-active-filters"></div>
    
    <!-- Starred resources section -->
    <div id="starred-resources">
      <!-- Section header will be added by JavaScript -->
      <ul class="resource-list"></ul>
    </div>
    
    <!-- All resources section -->
    <div id="all-resources">
      <!-- Section header will be added by JavaScript -->
      <ul class="resource-list"></ul>
    </div>
  </div>

  <div id="announcements" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Announcements</h1>
      <button class="btn btn-primary" onclick="showAnnouncementModal()">
        <i class="bi bi-plus-circle me-1"></i>New Announcement
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="announcement-search-input" placeholder="Search announcements..." oninput="filterAnnouncements(this.value)" />
          <button onclick="clearAnnouncementSearch()">✕</button>
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="announcement-sort-field" onchange="setAnnouncementSortField(this.value)">
            <option value="created">Date Created</option>
            <option value="name">Name</option>
          </select>
          <select id="announcement-sort-direction" onchange="setAnnouncementSortDirection(this.value)">
            <option value="desc">Descending</option>
            <option value="asc" selected>Ascending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Active filters -->
    <div id="announcement-active-filters"></div>
    
    <!-- Pinned announcements section -->
    <div id="pinned-announcements">
      <!-- Section header will be added by JavaScript -->
      <ul class="announcement-list"></ul>
    </div>
    
    <!-- All announcements section -->
    <div id="all-announcements">
      <!-- Section header will be added by JavaScript -->
      <ul class="announcement-list"></ul>
    </div>
  </div>

  <div id="quick-links" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Quick Links</h1>
      <button class="btn btn-primary" onclick="showQuickLinkModal()">
        <i class="bi bi-plus-circle me-1"></i>New Quick Link
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="quicklink-search-input" placeholder="Search quick links..." oninput="filterQuickLinks(this.value)" />
          <button onclick="clearQuickLinkSearch()">✕</button>
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="quicklink-sort-field" onchange="setQuickLinkSortField(this.value)">
            <option value="created">Date Created</option>
            <option value="name">Name</option>
            <option value="subject">Subject</option>
          </select>
          <select id="quicklink-sort-direction" onchange="setQuickLinkSortDirection(this.value)">
            <option value="desc">Descending</option>
            <option value="asc" selected>Ascending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Subject filter -->
    <div class="filter-container">
      <span class="filter-label">Filter by:</span>
      <select id="quicklink-subject-filter" onchange="filterQuickLinksBySubject(this.value)">
        <option value="">All Subjects</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    
    <!-- Active filters -->
    <div id="quicklink-active-filters"></div>
    
    <!-- Pinned quick links section -->
    <div id="pinned-quicklinks">
      <!-- Section header will be added by JavaScript -->
      <ul class="quicklink-list"></ul>
    </div>
    
    <!-- All quick links section -->
    <div id="all-quicklinks">
      <!-- Section header will be added by JavaScript -->
      <ul class="quicklink-list"></ul>
    </div>
  </div>

  <div id="recaps" class="section container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Recaps</h1>
      <button class="btn btn-primary" onclick="showRecapModal()">
        <i class="bi bi-plus-circle me-1"></i>New Recap
      </button>
    </div>
    
    <div class="controls-row">
      <!-- Search bar -->
      <div class="controls-group">
        <div class="search-container">
          <input type="text" id="recap-search-input" placeholder="Search recaps..." oninput="filterRecaps(this.value)" />
          <button onclick="clearRecapSearch()">✕</button>
        </div>
      </div>
      
      <!-- Date filter -->
      <div class="controls-group">
        <div class="filter-container">
          <span class="controls-label">Filter by date:</span>
          <input type="date" id="recap-date-filter" onchange="filterRecapsByDate(this.value)" />
        </div>
      </div>
      
      <!-- Sort controls -->
      <div class="controls-group">
        <div class="sort-container">
          <span class="controls-label">Sort by:</span>
          <select id="recap-sort-field" onchange="setRecapSortField(this.value)">
            <option value="date">Date</option>
            <option value="created">Date Created</option>
          </select>
          <select id="recap-sort-direction" onchange="setRecapSortDirection(this.value)">
            <option value="desc" selected>Descending</option>
            <option value="asc">Ascending</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Active filters -->
    <div id="recap-active-filters"></div>
    
    <!-- All recaps section -->
    <div id="all-recaps">
      <!-- Section header will be added by JavaScript -->
      <ul class="recap-list"></ul>
    </div>
  </div>

  <!-- Modal HTML -->
  <div id="assignment-modal">
    <div class="modal-content">
      <h2 id="modal-title">New Assignment</h2>
      
      <div class="form-group">
        <label for="modal-input">Assignment Name</label>
        <input type="text" id="modal-input" placeholder="Assignment name" autocomplete="off" />
      </div>
      
      <div class="form-group">
        <label for="subject-select">Subject</label>
        <select id="subject-select">
          <option value="">Select Subject</option>
          <option value="Math">Math</option>
          <option value="Science">Science</option>
          <option value="English">English</option>
          <option value="Filipino">Filipino</option>
          <option value="MAPEH/Music">MAPEH/Music</option>
          <option value="MAPEH/Arts">MAPEH/Arts</option>
          <option value="MAPEH/PE">MAPEH/PE</option>
          <option value="MAPEH/Health">MAPEH/Health</option>
          <option value="Research 2">Research 2</option>
          <option value="Analytic Geometry">Analytic Geometry</option>
          <option value="Electronics and Robotics">Electronics and Robotics</option>
          <option value="Values">Values</option>
          <option value="Araling Panlipunan">Araling Panlipunan</option>
          <option value="Homeroom">Homeroom</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Deadline</label>
        <div class="deadline-container">
          <div class="deadline-date">
            <input type="date" id="modal-deadline-date" />
          </div>
          <div class="deadline-time">
            <input type="time" id="modal-deadline-time" />
          </div>
        </div>
        <div class="all-day-container">
          <input type="checkbox" id="modal-all-day" onchange="toggleDeadlineTime()" checked />
          <label for="modal-all-day">All Day</label>
        </div>
      </div>
      
      <div class="form-group">
        <label for="modal-description">Description</label>
        <textarea id="modal-description" placeholder="Add notes or description"></textarea>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="modal-submit" onclick="submitAssignment()">Add</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Resource Modal HTML -->
  <div id="resource-modal">
    <div class="modal-content">
      <h2 id="resource-modal-title">New Resource</h2>
      
      <div class="form-group">
        <label for="resource-input">Resource Name</label>
        <input type="text" id="resource-input" placeholder="Resource name" autocomplete="off" />
      </div>
      
      <div class="form-group">
        <label for="resource-subject-select">Subject</label>
        <select id="resource-subject-select">
          <option value="">Select Subject</option>
          <option value="All Subjects">All Subjects</option>
          <option value="Math">Math</option>
          <option value="Science">Science</option>
          <option value="English">English</option>
          <option value="Filipino">Filipino</option>
          <option value="MAPEH/Music">MAPEH/Music</option>
          <option value="MAPEH/Arts">MAPEH/Arts</option>
          <option value="MAPEH/PE">MAPEH/PE</option>
          <option value="MAPEH/Health">MAPEH/Health</option>
          <option value="Research 2">Research 2</option>
          <option value="Analytic Geometry">Analytic Geometry</option>
          <option value="Electronics and Robotics">Electronics and Robotics</option>
          <option value="Values">Values</option>
          <option value="Araling Panlipunan">Araling Panlipunan</option>
          <option value="Homeroom">Homeroom</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="resource-description">Description</label>
        <textarea id="resource-description" placeholder="Add notes or description"></textarea>
      </div>
      
      <div class="form-group">
        <label>Resource Type</label>
        <div class="toggle-container">
          <span class="toggle-label">Link</span>
          <label class="toggle-switch">
            <input type="checkbox" id="resource-type-toggle" onchange="toggleResourceType()">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">File</span>
        </div>
      </div>
      
      <div id="resource-link-container" class="form-group">
        <label for="resource-link">Link</label>
        <input type="text" id="resource-link" placeholder="Enter resource link" />
      </div>
      
      <div id="resource-file-container" class="form-group" style="display: none;">
        <label for="resource-file">File</label>
        <input type="file" id="resource-file" />
        <p id="resource-file-name" style="font-size: 0.9em; color: #666; margin-top: 5px;"></p>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="resource-modal-submit" onclick="submitResource()">Add</button>
        <button onclick="closeResourceModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Announcement Modal HTML -->
  <div id="announcement-modal">
    <div class="modal-content">
      <h2 id="announcement-modal-title">New Announcement</h2>
      
      <div class="form-group">
        <label for="announcement-input">Announcement Title</label>
        <input type="text" id="announcement-input" placeholder="Announcement title" autocomplete="off" />
      </div>
      
      <div class="form-group">
        <label for="announcement-text">Announcement Text</label>
        <textarea id="announcement-text" placeholder="Enter announcement text" rows="5"></textarea>
      </div>
      
      <div class="form-group">
        <label>Attachments</label>
        <div id="attachment-container">
          <!-- Attachments will be added here dynamically -->
        </div>
        <div class="attachment-controls">
          <button type="button" onclick="addImageAttachment()" class="attachment-btn">
            <span class="icon">🖼️</span> Add Image
          </button>
          <button type="button" onclick="addLinkAttachment()" class="attachment-btn">
            <span class="icon">🔗</span> Add Link
          </button>
        </div>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="announcement-modal-submit" onclick="submitAnnouncement()">Add</button>
        <button onclick="closeAnnouncementModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Quick Link Modal HTML -->
  <div id="quicklink-modal">
    <div class="modal-content">
      <h2 id="quicklink-modal-title">New Quick Link</h2>
      
      <div class="form-group">
        <label for="quicklink-input">Link Name</label>
        <input type="text" id="quicklink-input" placeholder="Quick link name" autocomplete="off" />
      </div>
      
      <div class="form-group">
        <label for="quicklink-subject-select">Related Subject (Optional)</label>
        <select id="quicklink-subject-select">
          <option value="">None</option>
          <option value="All Subjects">All Subjects</option>
          <option value="Math">Math</option>
          <option value="Science">Science</option>
          <option value="English">English</option>
          <option value="Filipino">Filipino</option>
          <option value="MAPEH/Music">MAPEH/Music</option>
          <option value="MAPEH/Arts">MAPEH/Arts</option>
          <option value="MAPEH/PE">MAPEH/PE</option>
          <option value="MAPEH/Health">MAPEH/Health</option>
          <option value="Research 2">Research 2</option>
          <option value="Analytic Geometry">Analytic Geometry</option>
          <option value="Electronics and Robotics">Electronics and Robotics</option>
          <option value="Values">Values</option>
          <option value="Araling Panlipunan">Araling Panlipunan</option>
          <option value="Homeroom">Homeroom</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Link Type</label>
        <div class="toggle-container">
          <span class="toggle-label">URL</span>
          <label class="toggle-switch">
            <input type="checkbox" id="quicklink-type-toggle" onchange="toggleQuickLinkType()">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">File</span>
        </div>
      </div>
      
      <div id="quicklink-url-container" class="form-group">
        <label for="quicklink-url">URL</label>
        <input type="text" id="quicklink-url" placeholder="Enter URL" />
      </div>
      
      <div id="quicklink-file-container" class="form-group" style="display: none;">
        <label for="quicklink-file">File</label>
        <input type="file" id="quicklink-file" />
        <p id="quicklink-file-name" style="font-size: 0.9em; color: #666; margin-top: 5px;"></p>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="quicklink-modal-submit" onclick="submitQuickLink()">Add</button>
        <button onclick="closeQuickLinkModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal HTML -->
  <div id="schedule-modal">
    <div class="modal-content">
      <h2 id="schedule-modal-title">New Schedule Entry</h2>
      
      <div class="form-group">
        <label for="schedule-date">Date</label>
        <input type="date" id="schedule-date" required />
      </div>
      
      <div class="form-group">
        <label>Subject Plans</label>
        <div class="schedule-form-subjects">
          <!-- Math -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Math</div>
            <textarea id="schedule-subject-math" placeholder="Plans for Math class" rows="3"></textarea>
          </div>
          
          <!-- Science -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Science</div>
            <textarea id="schedule-subject-science" placeholder="Plans for Science class" rows="3"></textarea>
          </div>
          
          <!-- English -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">English</div>
            <textarea id="schedule-subject-english" placeholder="Plans for English class" rows="3"></textarea>
          </div>
          
          <!-- Filipino -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Filipino</div>
            <textarea id="schedule-subject-filipino" placeholder="Plans for Filipino class" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Music -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Music</div>
            <textarea id="schedule-subject-mapeh-music" placeholder="Plans for MAPEH/Music class" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Arts -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Arts</div>
            <textarea id="schedule-subject-mapeh-arts" placeholder="Plans for MAPEH/Arts class" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/PE -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/PE</div>
            <textarea id="schedule-subject-mapeh-pe" placeholder="Plans for MAPEH/PE class" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Health -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Health</div>
            <textarea id="schedule-subject-mapeh-health" placeholder="Plans for MAPEH/Health class" rows="3"></textarea>
          </div>
          
          <!-- Research 2 -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Research 2</div>
            <textarea id="schedule-subject-research" placeholder="Plans for Research 2 class" rows="3"></textarea>
          </div>
          
          <!-- Analytic Geometry -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Analytic Geometry</div>
            <textarea id="schedule-subject-geometry" placeholder="Plans for Analytic Geometry class" rows="3"></textarea>
          </div>
          
          <!-- Electronics and Robotics -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Electronics and Robotics</div>
            <textarea id="schedule-subject-electronics" placeholder="Plans for Electronics and Robotics class" rows="3"></textarea>
          </div>
          
          <!-- Values -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Values</div>
            <textarea id="schedule-subject-values" placeholder="Plans for Values class" rows="3"></textarea>
          </div>
          
          <!-- Araling Panlipunan -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Araling Panlipunan</div>
            <textarea id="schedule-subject-araling" placeholder="Plans for Araling Panlipunan class" rows="3"></textarea>
          </div>
          
          <!-- Homeroom -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Homeroom</div>
            <textarea id="schedule-subject-homeroom" placeholder="Plans for Homeroom" rows="3"></textarea>
          </div>
        </div>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="schedule-modal-submit" onclick="submitSchedule()">Add</button>
        <button onclick="closeScheduleModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Recap Modal HTML -->
  <div id="recap-modal">
    <div class="modal-content">
      <h2 id="recap-modal-title">New Recap</h2>
      
      <div class="form-group">
        <label for="recap-date">Date</label>
        <input type="date" id="recap-date" required />
      </div>
      
      <div class="form-group">
        <label>Subject Recaps</label>
        <div class="recap-form-subjects">
          <!-- Math -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Math</div>
            <textarea id="recap-subject-math" placeholder="What was covered in Math today?" rows="3"></textarea>
          </div>
          
          <!-- Science -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Science</div>
            <textarea id="recap-subject-science" placeholder="What was covered in Science today?" rows="3"></textarea>
          </div>
          
          <!-- English -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">English</div>
            <textarea id="recap-subject-english" placeholder="What was covered in English today?" rows="3"></textarea>
          </div>
          
          <!-- Filipino -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Filipino</div>
            <textarea id="recap-subject-filipino" placeholder="What was covered in Filipino today?" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Music -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Music</div>
            <textarea id="recap-subject-mapeh-music" placeholder="What was covered in MAPEH/Music today?" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Arts -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Arts</div>
            <textarea id="recap-subject-mapeh-arts" placeholder="What was covered in MAPEH/Arts today?" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/PE -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/PE</div>
            <textarea id="recap-subject-mapeh-pe" placeholder="What was covered in MAPEH/PE today?" rows="3"></textarea>
          </div>
          
          <!-- MAPEH/Health -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">MAPEH/Health</div>
            <textarea id="recap-subject-mapeh-health" placeholder="What was covered in MAPEH/Health today?" rows="3"></textarea>
          </div>
          
          <!-- Research 2 -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Research 2</div>
            <textarea id="recap-subject-research" placeholder="What was covered in Research 2 today?" rows="3"></textarea>
          </div>
          
          <!-- Analytic Geometry -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Analytic Geometry</div>
            <textarea id="recap-subject-geometry" placeholder="What was covered in Analytic Geometry today?" rows="3"></textarea>
          </div>
          
          <!-- Electronics and Robotics -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Electronics and Robotics</div>
            <textarea id="recap-subject-electronics" placeholder="What was covered in Electronics and Robotics today?" rows="3"></textarea>
          </div>
          
          <!-- Values -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Values</div>
            <textarea id="recap-subject-values" placeholder="What was covered in Values today?" rows="3"></textarea>
          </div>
          
          <!-- Araling Panlipunan -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Araling Panlipunan</div>
            <textarea id="recap-subject-araling" placeholder="What was covered in Araling Panlipunan today?" rows="3"></textarea>
          </div>
          
          <!-- Homeroom -->
          <div class="recap-form-subject">
            <div class="recap-form-subject-header">Homeroom</div>
            <textarea id="recap-subject-homeroom" placeholder="What was covered in Homeroom today?" rows="3"></textarea>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Action Items</label>
        <div class="action-items-container">
          <div class="action-items-title">Add action items (one per line)</div>
          <p class="action-items-description" style="font-size: 0.9em; color: #666;">
            Each line will be displayed as a bullet point. Example format:<br>
            "John will complete the presentation"<br>
            "Maria is in charge of research"
          </p>
          <textarea id="recap-action-items" placeholder="Enter action items (one per line)" rows="5"></textarea>
        </div>
      </div>
      
      <div class="form-group" style="text-align: center; margin-top: 20px;">
        <button id="recap-modal-submit" onclick="submitRecap()">Add</button>
        <button onclick="closeRecapModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Image Preview Overlay -->
  <div id="image-preview-overlay">
    <div id="image-preview-container">
      <img id="image-preview" src="" alt="Preview" />
      <button id="image-preview-close">×</button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
 